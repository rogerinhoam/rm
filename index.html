<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R.M. Estética Automotiva - Gestor PRO+</title>
    
    <!-- Google Fonts: Poppins for headings, Inter for body -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Importa o cliente Supabase via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

    <!-- jsPDF para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.autotable.min.js"></script>

    <!-- Estilos CSS -->
    <style>
        :root {
            --bg-dark: #0f172a; /* Darker blue-gray */
            --bg-card: #1e293b; /* Slightly lighter for cards */
            --bg-input: #334155; /* Even lighter for inputs */
            --text-light: #e2e8f0; /* Off-white for main text */
            --text-muted: #94a3b8; /* Muted gray for labels/small text */
            --primary-red: #ef4444; /* Modern, vibrant red */
            --primary-red-dark: #dc2626; /* Darker red on hover */
            --accent-green: #22c55e; /* Green for success */
            --accent-green-dark: #16a34a;
            --accent-blue: #3b82f6; /* Blue for info/active */
            --accent-blue-dark: #2563eb;
            --accent-orange: #f97316; /* Orange for warning */
            --accent-orange-dark: #ea580c;
            --accent-red-status: #ef4444; /* Red for cancellation/danger */
            --border-color: #475569; /* Subtle border */
            --shadow-color: rgba(0, 0, 0, 0.3); /* Deeper shadow */
            --header-border: #64748b; /* Lighter border for header */

            /* Skeleton loading colors */
            --skeleton-base: #334155;
            --skeleton-highlight: #475569;
        }

        /* Base styles, resets, and typography */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        html { 
            scroll-behavior: smooth; 
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            color: var(--text-light);
        }

        /* Main application container */
        .app-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }

        /* Header styling */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--header-border);
            padding-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        header h1 { 
            color: var(--primary-red); 
            font-size: 2rem; 
            font-weight: 700; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        header h1 i {
            color: var(--accent-blue);
        }

        /* Navigation styling */
        nav { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            margin-bottom: 30px;
        }
        .nav-btn {
            padding: 12px 20px;
            background-color: var(--bg-card);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            flex-grow: 1; /* Makes buttons take up space on smaller screens */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        @media (min-width: 600px) {
            .nav-btn { flex-grow: 0; } /* Reverts on larger screens */
        }

        .nav-btn:hover { 
            background-color: var(--bg-input); 
            color: var(--text-light);
            border-color: var(--primary-red); 
        }
        .nav-btn.active { 
            background-color: var(--primary-red); 
            color: white; 
            font-weight: bold; 
            border-color: var(--primary-red); 
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
        }
        
        /* Sync button styling */
        .sync-btn {
            background: none; 
            border: none; 
            color: var(--text-muted); 
            cursor: pointer;
            font-size: 2.2rem; 
            transition: color 0.3s, transform 0.3s;
            padding: 5px; /* Increase tap area */
        }
        .sync-btn:hover {
            color: var(--primary-red);
            transform: rotate(15deg);
        }
        .sync-btn.syncing { 
            animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; 
            color: var(--accent-blue);
        }
        @keyframes spin { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(360deg); } 
        }

        /* Tab content animations */
        .tab-content { 
            display: none; 
            animation: fadeInScale 0.6s ease-out; 
            transform-origin: top;
        }
        .tab-content.active { 
            display: block; 
        }

        @keyframes fadeInScale { 
            from { opacity: 0; transform: translateY(20px) scale(0.98); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        
        /* Grid layouts for different sections */
        .grid-layout, .historico-layout, .dashboard-main-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 25px; 
        }
        @media (min-width: 768px) { 
            .grid-layout { grid-template-columns: 1fr 1.5fr; } 
            .dashboard-main-grid { grid-template-columns: 1.8fr 1fr; } /* Adjust dashboard grid for chart */
        }
        @media (min-width: 992px) {
            .historico-layout { grid-template-columns: 1fr 1.5fr; }
        }

        /* Card styling */
        .card { 
            background-color: var(--bg-card); 
            padding: 30px; 
            border-radius: 15px; 
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 25px var(--shadow-color);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }
        .card h2 {
            margin-top: 0; 
            margin-bottom: 25px; 
            color: var(--primary-red);
            border-bottom: 2px solid var(--primary-red); 
            padding-bottom: 12px; 
            font-size: 1.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Form elements styling */
        .form-group { 
            margin-bottom: 20px; 
            position: relative;
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            color: var(--text-muted); 
            font-size: 0.95rem; 
            font-weight: 500;
        }
        
        .search-container { 
            position: relative; 
            margin-bottom: 25px; 
        }
        .search-container input { 
            padding-left: 45px; /* Space for icon */
        }
        .search-container i.fa-search { 
            position: absolute; 
            left: 15px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--text-muted); 
            font-size: 1.1rem;
        }

        input, select, textarea {
            width: 100%; 
            padding: 15px; 
            background-color: var(--bg-input);
            border: 1.5px solid var(--border-color); /* Slightly thicker border for inputs */
            border-radius: 10px;
            color: var(--text-light); 
            font-size: 1.05rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
        }

        /* Validation feedback */
        input:invalid:not(:focus):not(:placeholder-shown) {
            border-color: var(--accent-red-status);
        }
        .form-group .validation-message {
            color: var(--accent-red-status);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none; 
        }
        /* Show validation message when input is invalid and touched */
        input:invalid:not(:focus):not(:placeholder-shown) + .validation-message {
            display: block;
        }
        /* Validation icons */
        .form-group .validation-icon {
            position: absolute;
            right: 15px;
            top: 50%; 
            transform: translateY(20%); 
            font-size: 1.1rem;
        }
        .form-group input:not(:placeholder-shown):valid + .validation-message + .validation-icon {
            color: var(--accent-green);
        }
        .form-group input:invalid:not(:focus):not(:placeholder-shown) + .validation-message + .validation-icon {
            color: var(--accent-red-status);
        }
        .form-group select + .validation-message + .validation-icon,
        .form-group input:not(:required) + .validation-message + .validation-icon,
        .form-group input:focus + .validation-message + .validation-icon,
        .form-group input:placeholder-shown + .validation-message + .validation-icon {
             display: none; 
        }


        /* Button styling */
        .btn {
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 8px; 
            padding: 14px 25px; 
            border: none; 
            border-radius: 10px;
            cursor: pointer; 
            font-weight: 600; 
            text-transform: uppercase;
            font-size: 0.95rem; 
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            width: 100%; 
            text-align: center; 
            margin-top: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        @media(min-width: 992px) { 
            .btn { width: auto; } 
        }
        
        .btn:active { 
            transform: translateY(1px); 
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        .btn-primary { 
            background-color: var(--primary-red); 
            color: white; 
        }
        .btn-primary:hover { 
            background-color: var(--primary-red-dark); 
            box-shadow: 0 5px 12px rgba(239, 68, 68, 0.4);
        }
        .btn-secondary { 
            background-color: #475569; 
            color: var(--text-light); 
        }
        .btn-secondary:hover { 
            background-color: #64748b; 
        }
        .btn-danger { 
            background-color: var(--accent-red-status); 
            color: white; 
        }
        .btn-success { 
            background-color: var(--accent-green); 
            color: white; 
        }
        .btn-success:hover { 
            background-color: var(--accent-green-dark); 
        }
        .btn-sm { 
            padding: 10px 18px; 
            font-size: 0.85rem; 
            width: auto; 
        }

        /* Data list styling */
        .data-list ul { 
            list-style: none; 
            padding: 0; 
            max-height: 550px; 
            overflow-y: auto; 
            margin-top: 10px;
        }
        /* Scrollbar styles */
        .data-list ul::-webkit-scrollbar {
            width: 8px;
        }
        .data-list ul::-webkit-scrollbar-track {
            background: var(--bg-input);
            border-radius: 10px;
        }
        .data-list ul::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
        }
        .data-list ul::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Empty state message */
        .empty-list-message {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-muted);
            background-color: var(--bg-input);
            border-radius: 10px;
            border: 2px dashed var(--border-color);
            margin-top: 15px;
        }
        .empty-list-message p { 
            font-size: 1.2rem; 
            margin-bottom: 15px; 
            font-weight: 500;
        }
        .empty-list-message small {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .data-list li {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 18px;
            background-color: var(--bg-input);
            border-radius: 10px; 
            margin-bottom: 12px; 
            flex-wrap: wrap; 
            gap: 15px;
            border-left: 5px solid var(--border-color);
            transition: border-left-color 0.3s ease, background-color 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .data-list li.editing {
            border-left: 5px solid var(--accent-orange); /* Highlight editing row */
        }
        .data-list li:hover { 
            border-left-color: var(--primary-red); 
            background-color: #2b3a4e; 
        }
        .data-list li.selected {
            border-left-color: var(--accent-blue);
            background-color: #2b3a4e;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .data-list li > div:first-child { 
            flex-grow: 1; 
        }
        .data-list li strong {
            font-size: 1.1rem;
            color: var(--text-light);
        }
        .data-list li small {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        .item-actions { 
            display: flex; 
            gap: 10px; 
            flex-shrink: 0; 
            align-items: center; 
        }
        /* Inline editing input */
        .inline-edit-input {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 5px 8px;
            color: var(--text-light);
            font-size: 0.95rem;
            margin: -5px 0; /* Adjust to align with text */
        }
        .inline-edit-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        /* Hide text spans when editing */
        .data-list li.editing span[data-field], .data-list li.editing strong[data-field] {
            display: none;
        }
        /* Show input fields when editing */
        .data-list li .edit-mode-input {
            display: none; /* Hidden by default */
        }
        .data-list li.editing .edit-mode-input {
            display: inline-block; /* Show when editing */
        }


        /* Quantity input for orcamento items */
        .orcamento-item-quantity {
            width: 70px;
            padding: 8px;
            margin-left: 10px;
            font-size: 0.9rem;
            text-align: center;
            -moz-appearance: textfield; 
        }
        .orcamento-item-quantity::-webkit-inner-spin-button,
        .orcamento-item-quantity::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Orcamento total display */
        #orcamento-total { 
            margin-top: 30px; 
            font-size: 2rem; 
            font-weight: bold; 
            color: var(--accent-green); 
            text-align: center; 
            padding-top: 20px;
            border-top: 1px dashed var(--border-color);
        }
        
        /* Payment options grid */
        .payment-options-group { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 10px; 
        }
        .payment-option {
            padding: 14px 15px; 
            background-color: var(--bg-input); 
            border: 1px solid var(--border-color);
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.2s ease;
            font-size: 0.95rem; 
            color: var(--text-muted); 
            text-align: center;
            font-weight: 500;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .payment-option:hover {
            background-color: var(--border-color);
            color: var(--text-light);
        }
        .payment-option.active {
            background-color: var(--accent-blue); 
            color: white; 
            border-color: var(--accent-blue); 
            font-weight: bold;
            box-shadow: 0 3px 8px rgba(59, 130, 246, 0.3);
        }
        
        #historico-lista li, #recent-activity-list li { 
            cursor: pointer; 
            transition: background-color 0.2s, border-left-color 0.2s; 
        }
        
        /* Status indicators */
        .status-indicator { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            color: white; 
            font-weight: 600; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-Orçamento { background-color: var(--accent-blue); }
        .status-Aprovado { background-color: var(--accent-orange); }
        .status-Finalizado { background-color: var(--accent-green); }
        .status-Cancelado { background-color: var(--accent-red-status); }

        /* Detail view switcher buttons */
        .detalhe-view-switcher { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 15px;
            flex-wrap: wrap;
        }
        .detalhe-view-btn { 
            padding: 10px 18px; 
            background-color: var(--bg-input); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            cursor: pointer; 
            flex-grow: 1; 
            text-align: center;
            color: var(--text-muted);
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .detalhe-view-btn:hover {
            background-color: var(--border-color);
            color: var(--text-light);
        }
        .detalhe-view-btn.active { 
            background-color: var(--primary-red); 
            color: white; 
            font-weight: bold; 
            border-color: var(--primary-red); 
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        /* Detail block styling */
        .detalhe-bloco {
            background-color: var(--bg-dark); 
            border: 1px solid var(--border-color);
            border-radius: 12px; 
            padding: 20px; 
            margin-top: 15px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        .detalhe-bloco h3 { 
            margin-top: 0; 
            margin-bottom: 15px; 
            color: var(--primary-red); 
            font-size: 1.2rem; 
            font-weight: 600; 
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .detalhe-bloco pre {
            white-space: pre-wrap; 
            word-wrap: break-word; 
            color: var(--text-light);
            font-family: 'Inter', monospace; 
            font-size: 0.95rem;
            background-color: var(--bg-input); 
            padding: 18px; 
            border-radius: 10px;
            border: 1px solid var(--border-color);
            line-height: 1.7;
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--bg-input);
        }
        .detalhe-bloco pre::-webkit-scrollbar { width: 8px; }
        .detalhe-bloco pre::-webkit-scrollbar-track { background: var(--bg-input); }
        .detalhe-bloco pre::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        .detalhe-bloco pre::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }


        .detalhe-bloco-actions, .detalhes-status-actions { 
            margin-top: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            justify-content: flex-start;
        }
        .detalhes-status-actions { 
            padding-top: 20px; 
            border-top: 1px solid var(--border-color); 
        }
        
        /* Dashboard statistics grid */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 20px; 
        }
        .stat-card { 
            background-color: var(--bg-card); 
            padding: 25px; 
            border-radius: 12px; 
            border: 1px solid var(--border-color); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease; /* Add box-shadow to transition */
            cursor: pointer; /* Indicate clickable */
            text-align: center; 
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); /* Stronger shadow on hover */
        }
        .stat-card .icon { 
            font-size: 3rem; 
            margin-bottom: 15px; 
            color: var(--accent-blue);
        }
        .stat-card h3 { 
            font-size: 0.9rem; 
            color: var(--text-muted); 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            font-weight: 600;
            letter-spacing: 0.8px;
        }
        .stat-card p { 
            font-size: 2.2rem; 
            font-weight: bold; 
            color: var(--primary-red); 
            line-height: 1;
        }

        /* Monthly Stats Chart */
        .monthly-stats-chart {
            background-color: var(--bg-input);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 250px;
        }


        /* Notification & Modals */
        #notification {
            position: fixed; 
            bottom: 25px; 
            left: 50%; 
            transform: translate(-50%, 150%); 
            padding: 18px 25px; 
            border-radius: 10px; 
            color: white; 
            z-index: 1000;
            text-align: center; 
            visibility: hidden; 
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55), visibility 0.6s;
            max-width: 90%; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            font-weight: 500;
            min-width: 280px;
        }
        #notification.show { 
            transform: translate(-50%, 0); 
            visibility: visible; 
        }
        #notification.success { 
            background-color: var(--accent-green); 
        }
        #notification.error { 
            background-color: var(--accent-red-status); 
        }
        #notification.warning {
            background-color: var(--accent-orange);
        }

        .modal-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background-color: rgba(0,0,0,0.85); 
            display: none; 
            justify-content: center;
            align-items: center; 
            z-index: 2000; 
            padding: 20px;
            backdrop-filter: blur(5px); 
            animation: fadeIn 0.3s ease-out;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background-color: var(--bg-card); 
            padding: 35px; 
            border-radius: 15px;
            text-align: center; 
            max-width: 450px; 
            width: 100%;
            border: 1px solid var(--border-color); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            animation: slideInUp 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h3 { 
            margin-bottom: 20px; 
            color: var(--primary-red); 
            font-size: 1.8rem;
            font-weight: 600;
        }
        .modal-content p { 
            margin-bottom: 30px; 
            color: var(--text-light);
            font-size: 1.1rem;
        }
        .modal-actions { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
        }
        
        /* Sync Overlay */
        #sync-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background-color: rgba(0,0,0,0.9); 
            display: none; 
            justify-content: center;
            align-items: center; 
            z-index: 3000; 
            color: white; 
            text-align: center;
            font-size: 1.3rem; 
            flex-direction: column; 
            gap: 25px;
            backdrop-filter: blur(8px);
        }
        #sync-overlay .sync-spinner {
            font-size: 4rem;
            animation: spin 1.5s linear infinite;
            color: var(--accent-blue);
        }
        
        /* Back to Top Button */
        #back-to-top-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 55px;
            height: 55px;
            background-color: var(--primary-red);
            color: white;
            border: none;
            border-radius: 50%;
            display: none; 
            justify-content: center;
            align-items: center;
            font-size: 26px;
            cursor: pointer;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.4s ease, transform 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }
        #back-to-top-btn.show {
            display: flex;
            opacity: 0.9;
        }
        #back-to-top-btn:hover {
            opacity: 1;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }
        #back-to-top-btn i {
            pointer-events: none; 
        }

        /* Export Buttons */
        .export-actions {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .export-actions .btn-sm {
            flex-grow: 1;
        }
        @media (min-width: 600px) {
            .export-actions .btn-sm {
                flex-grow: 0;
            }
        }

        /* Offline indicator */
        #offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--accent-red-status);
            color: white;
            text-align: center;
            padding: 10px;
            font-weight: 600;
            z-index: 3001; 
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            animation: slideDown 0.5s ease-out;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        /* Skeleton Loading Effect */
        .skeleton-loading {
            background: linear-gradient(90deg, var(--skeleton-base) 25%, var(--skeleton-highlight) 50%, var(--skeleton-base) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px; 
            margin-bottom: 10px;
            opacity: 0.7;
        }
        .skeleton-loading-text {
            height: 1.2em; 
            margin-bottom: 0.5em;
        }
        .skeleton-loading-list-item {
            height: 60px; 
            margin-bottom: 12px;
        }
        .skeleton-loading-stat-card {
            height: 150px; /* Adjusted height for consistency */
            border-radius: 12px;
        }
        .skeleton-loading-chart {
            height: 250px; 
            width: 100%;
            border-radius: 10px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Confetti Effect */
        .confetti {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: currentColor;
            opacity: 0;
            border-radius: 50%;
            animation: confetti-fall 2s ease-out forwards;
            z-index: 3000;
        }

        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translate(0, 0) rotate(0deg) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--x), var(--y)) rotate(720deg) scale(0.5);
            }
        }

        /* History filters */
        .filter-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-options select, .filter-options input[type="date"], .filter-options .btn {
            flex-grow: 1;
            min-width: 120px;
            margin-top: 0; /* Override default btn margin */
        }
        @media(min-width: 768px){
            .filter-options .btn {
                 flex-grow: 0;
            }
        }


        /* Client Details Panel */
        .client-details-panel {
            background-color: var(--bg-card); 
            padding: 30px; 
            border-radius: 15px; 
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 25px var(--shadow-color);
            margin-top: 25px;
            display: none; /* Hidden by default */
            animation: fadeInScale 0.6s ease-out; 
        }
        .client-details-panel h2 {
            margin-top: 0; 
            margin-bottom: 25px; 
            color: var(--accent-blue);
            border-bottom: 2px solid var(--accent-blue); 
            padding-bottom: 12px; 
            font-size: 1.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .client-details-panel .detail-item {
            margin-bottom: 10px;
        }
        .client-details-panel .detail-item strong {
            color: var(--text-light);
            margin-right: 5px;
        }
        .client-details-panel .detail-item span {
            color: var(--text-muted);
        }
        .client-details-panel .section-title {
            font-size: 1.3rem;
            color: var(--primary-red);
            margin-top: 20px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        .client-details-panel .past-orcamento-list li {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .client-details-panel .past-orcamento-list li:hover {
            background-color: var(--bg-input);
        }
        .client-details-panel .past-orcamento-list li strong {
            display: block;
            margin-bottom: 5px;
        }
        .client-details-panel .close-details-btn {
            background-color: var(--accent-red-status);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            float: right; /* Position to top right */
            margin-top: -5px; /* Adjust as needed */
        }
        .client-details-panel .close-details-btn:hover {
            background-color: var(--primary-red-dark);
        }
        
    </style>
</head>
<body>

    <div id="offline-indicator" role="alert" aria-live="assertive">Você está offline. Conecte-se para sincronizar os dados.</div>

    <div class="app-container">
        <header>
            <h1><i class="fas fa-car-wash" aria-hidden="true"></i> R.M. Estética PRO+</h1>
            <button class="sync-btn" id="sync-btn" title="Sincronizar Dados Manualmente" aria-label="Sincronizar Dados Manualmente"><i class="fas fa-sync-alt" aria-hidden="true"></i></button>
        </header>

        <nav role="navigation" aria-label="Navegação Principal">
            <button class="nav-btn active" data-tab="dashboard" role="tab" aria-selected="true" aria-controls="dashboard-tab"><i class="fas fa-chart-line" aria-hidden="true"></i> Painel</button>
            <button class="nav-btn" data-tab="clientes" role="tab" aria-selected="false" aria-controls="clientes-tab"><i class="fas fa-users" aria-hidden="true"></i> Clientes</button>
            <button class="nav-btn" data-tab="servicos" role="tab" aria-selected="false" aria-controls="servicos-tab"><i class="fas fa-tools" aria-hidden="true"></i> Serviços</button>
            <button class="nav-btn" data-tab="novo-orcamento" role="tab" aria-selected="false" aria-controls="novo-orcamento-tab"><i class="fas fa-file-invoice" aria-hidden="true"></i> Orçamento</button>
            <button class="nav-btn" data-tab="historico" role="tab" aria-selected="false" aria-controls="historico-tab"><i class="fas fa-history" aria-hidden="true"></i> Histórico</button>
        </nav>

        <main>
            <section id="dashboard-tab" class="tab-content active" role="tabpanel">
                <div class="dashboard-main-grid">
                    <div>
                        <div id="dashboard-stats-container" class="dashboard-grid">
                            <div class="stat-card" data-target-tab="clientes" data-filter-type="none" tabindex="0" role="button" aria-label="Ver todos os clientes">
                                <div class="icon"><i class="fas fa-users" aria-hidden="true"></i></div>
                                <h3>Clientes</h3>
                                <p id="stat-clientes"></p>
                            </div>
                            <div class="stat-card" data-target-tab="historico" data-filter-type="status" data-filter-value="Orçamento" tabindex="0" role="button" aria-label="Ver orçamentos pendentes">
                                <div class="icon"><i class="fas fa-hourglass-half" aria-hidden="true"></i></div>
                                <h3>Pendentes</h3>
                                <p id="stat-pendentes"></p>
                            </div>
                            <div class="stat-card" data-target-tab="historico" data-filter-type="status" data-filter-value="Aprovado" tabindex="0" role="button" aria-label="Ver orçamentos aprovados">
                                <div class="icon"><i class="fas fa-check-circle" aria-hidden="true"></i></div>
                                <h3>Aprovados</h3>
                                <p id="stat-aprovados"></p>
                            </div>
                            <div class="stat-card" data-target-tab="historico" data-filter-type="status" data-filter-value="Finalizado" tabindex="0" role="button" aria-label="Ver orçamentos finalizados este mês">
                                <div class="icon"><i class="fas fa-calendar-check" aria-hidden="true"></i></div>
                                <h3>Finalizados Mês</h3>
                                <p id="stat-finalizados-mes"></p>
                            </div>
                            <div class="stat-card" data-target-tab="historico" data-filter-type="status" data-filter-value="Finalizado" style="grid-column: 1 / -1;" tabindex="0" role="button" aria-label="Ver faturamento total">
                                <div class="icon"><i class="fas fa-dollar-sign" aria-hidden="true"></i></div>
                                <h3>Faturamento Total</h3>
                                <p id="stat-faturamento-total"></p>
                            </div>
                        </div>
                        <div class="monthly-stats-chart">
                            <h3><i class="fas fa-chart-bar" aria-hidden="true"></i> Finalizados por Mês</h3>
                            <canvas id="monthly-finalized-chart-canvas"></canvas>
                        </div>
                    </div>
                    <div class="card data-list">
                        <h2><i class="fas fa-bolt" aria-hidden="true"></i> Atividade Recente</h2>
                        <ul id="recent-activity-list" role="list">
                            </ul>
                    </div>
                </div>
            </section>
            
            <section id="clientes-tab" class="tab-content" role="tabpanel">
                 <div class="grid-layout">
                     <div class="card">
                         <h2 id="cliente-form-title">Novo Cliente <i class="fas fa-user-plus" aria-hidden="true"></i></h2>
                         <form id="cliente-form">
                             <input type="hidden" id="cliente-id">
                             <div class="form-group">
                                 <label for="cliente-nome">Nome Completo</label>
                                 <input type="text" id="cliente-nome" required aria-required="true" placeholder="João da Silva" aria-label="Nome Completo do Cliente">
                                 <span class="validation-message" aria-live="polite">O nome do cliente é obrigatório.</span>
                                 <i class="validation-icon fas" aria-hidden="true"></i>
                             </div>
                             <div class="form-group">
                                 <label for="cliente-telefone">Telefone (WhatsApp)</label>
                                 <input type="tel" id="cliente-telefone" placeholder="(XX) XXXXX-XXXX" pattern="\(\d{2}\) \d{4,5}-\d{4}" aria-label="Telefone do Cliente com WhatsApp">
                                 <span class="validation-message" aria-live="polite">Formato inválido. Ex: (21) 98765-4321</span>
                                 <i class="validation-icon fas" aria-hidden="true"></i>
                             </div>
                             <div class="form-group">
                                 <label for="cliente-carro">Veículo</label>
                                 <input type="text" id="cliente-carro" placeholder="Ex: Honda Civic, Chevrolet Onix" aria-label="Modelo do Veículo do Cliente">
                             </div>
                             <div class="form-group">
                                 <label for="cliente-placa">Placa</label>
                                 <input type="text" id="cliente-placa" placeholder="ABC1D23" pattern="[A-Za-z]{3}-?\d{4}|[A-Za-z]{3}\d[A-Za-z]\d{2}" aria-label="Placa do Veículo do Cliente">
                                 <span class="validation-message" aria-live="polite">Formato de placa inválido.</span>
                                 <i class="validation-icon fas" aria-hidden="true"></i>
                             </div>
                             <button type="submit" class="btn btn-primary" aria-label="Salvar Cliente"><i class="fas fa-save" aria-hidden="true"></i> Salvar</button>
                             <button type="button" id="cancelar-edicao-cliente" class="btn btn-secondary" style="display: none;" aria-label="Cancelar Edição de Cliente"><i class="fas fa-times-circle" aria-hidden="true"></i> Cancelar</button>
                         </form>
                     </div>
                     <div class="card data-list">
                         <h2>Clientes Cadastrados <i class="fas fa-users" aria-hidden="true"></i></h2>
                         <div class="search-container">
                             <i class="fas fa-search" aria-hidden="true"></i>
                             <input type="search" id="search-cliente" placeholder="Buscar cliente por nome ou placa..." aria-label="Pesquisar Cliente">
                         </div>
                         <div style="margin-bottom: 15px;">
                             <label for="sort-clientes" style="display: block; margin-bottom: 5px; color: var(--text-muted);">Ordenar por:</label>
                             <select id="sort-clientes" style="width: 100%; padding: 8px; border-radius: 5px; background-color: var(--bg-input); color: var(--text-light);" aria-label="Ordenar Clientes por">
                                 <option value="nome_asc">Nome (A-Z)</option>
                                 <option value="nome_desc">Nome (Z-A)</option>
                                 <option value="carro_asc">Veículo (A-Z)</option>
                                 <option value="placa_asc">Placa (A-Z)</option>
                             </select>
                         </div>
                         <ul id="clientes-lista" role="list">
                             </ul>
                         <div class="export-actions">
                             <button id="export-clientes-csv" class="btn btn-sm btn-secondary" aria-label="Exportar Clientes para CSV"><i class="fas fa-file-csv" aria-hidden="true"></i> Exportar CSV</button>
                         </div>
                     </div>
                 </div>
                <div id="client-details-panel" class="client-details-panel">
                    <button class="close-details-btn" aria-label="Fechar Detalhes do Cliente"><i class="fas fa-times" aria-hidden="true"></i></button>
                    <h2><i class="fas fa-user-circle" aria-hidden="true"></i> Detalhes do Cliente</h2>
                    <div class="client-info">
                        <div class="detail-item"><strong>Nome:</strong> <span id="client-detail-name"></span></div>
                        <div class="detail-item"><strong>Telefone:</strong> <span id="client-detail-phone"></span></div>
                        <div class="detail-item"><strong>Veículo:</strong> <span id="client-detail-car"></span></div>
                        <div class="detail-item"><strong>Placa:</strong> <span id="client-detail-plate"></span></div>
                    </div>
                    
                    <h3 class="section-title">Histórico de Orçamentos <i class="fas fa-history" aria-hidden="true"></i></h3>
                    <ul id="client-past-orcamentos" class="data-list past-orcamento-list" role="list">
                        </ul>
                </div>
            </section>
            
            <section id="servicos-tab" class="tab-content" role="tabpanel">
                 <div class="grid-layout">
                     <div class="card">
                         <h2 id="servico-form-title">Novo Serviço <i class="fas fa-clipboard-list" aria-hidden="true"></i></h2>
                         <form id="servico-form">
                             <input type="hidden" id="servico-id">
                             <div class="form-group">
                                 <label for="servico-descricao">Descrição</label>
                                 <input type="text" id="servico-descricao" required aria-required="true" placeholder="Ex: Polimento Técnico" aria-label="Descrição do Serviço">
                                 <span class="validation-message" aria-live="polite">A descrição do serviço é obrigatória.</span>
                                 <i class="validation-icon fas" aria-hidden="true"></i>
                             </div>
                             <div class="form-group">
                                 <label for="servico-valor">Valor (R$)</label>
                                 <input type="number" id="servico-valor" step="0.01" required min="0.01" placeholder="Ex: 150.00" aria-required="true" aria-label="Valor do Serviço">
                                 <span class="validation-message" aria-live="polite">O valor do serviço deve ser um número positivo.</span>
                                 <i class="validation-icon fas" aria-hidden="true"></i>
                             </div>
                             <button type="submit" class="btn btn-primary" aria-label="Salvar Serviço"><i class="fas fa-save" aria-hidden="true"></i> Salvar</button>
                             <button type="button" id="cancelar-edicao-servico" class="btn btn-secondary" style="display: none;" aria-label="Cancelar Edição de Serviço"><i class="fas fa-times-circle" aria-hidden="true"></i> Cancelar</button>
                         </form>
                     </div>
                      <div class="card data-list">
                         <h2>Serviços Cadastrados <i class="fas fa-tools" aria-hidden="true"></i></h2>
                         <div class="search-container">
                             <i class="fas fa-search" aria-hidden="true"></i>
                             <input type="search" id="search-servico" placeholder="Buscar serviço por descrição..." aria-label="Pesquisar Serviço">
                         </div>
                         <div style="margin-bottom: 15px;">
                             <label for="sort-servicos" style="display: block; margin-bottom: 5px; color: var(--text-muted);">Ordenar por:</label>
                             <select id="sort-servicos" style="width: 100%; padding: 8px; border-radius: 5px; background-color: var(--bg-input); color: var(--text-light);" aria-label="Ordenar Serviços por">
                                 <option value="descricao_asc">Descrição (A-Z)</option>
                                 <option value="descricao_desc">Descrição (Z-A)</option>
                                 <option value="valor_asc">Valor (Menor p/ Maior)</option>
                                 <option value="valor_desc">Valor (Maior p/ Menor)</option>
                             </select>
                         </div>
                         <ul id="servicos-lista" role="list">
                             </ul>
                          <div class="export-actions">
                             <button id="export-servicos-csv" class="btn btn-sm btn-secondary" aria-label="Exportar Serviços para CSV"><i class="fas fa-file-csv" aria-hidden="true"></i> Exportar CSV</button>
                         </div>
                     </div>
                 </div>
            </section>

            <section id="novo-orcamento-tab" class="tab-content" role="tabpanel">
                <div class="card">
                    <h2 id="orcamento-form-title">Criar Novo Orçamento <i class="fas fa-file-invoice-dollar" aria-hidden="true"></i></h2>
                    <form id="orcamento-form">
                        <input type="hidden" id="orcamento-id-to-edit">
                        <div class="form-group">
                            <label for="orcamento-cliente">Cliente</label>
                            <select id="orcamento-cliente" required aria-required="true" aria-label="Selecionar Cliente para Orçamento">
                                <option value="">Carregando clientes...</option>
                            </select>
                            <span class="validation-message" aria-live="polite">Selecione um cliente.</span>
                            <i class="validation-icon fas" aria-hidden="true"></i>
                        </div>
                        <div class="form-group">
                            <label for="orcamento-servico-select">Adicionar Serviço</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="orcamento-servico-select" style="flex-grow: 1;" aria-label="Selecionar Serviço para Adicionar">
                                    <option value="">Carregando serviços...</option>
                                </select>
                                <input type="number" id="orcamento-servico-quantidade" min="1" value="1" style="width: 80px; text-align: center;" aria-label="Quantidade do Serviço">
                                <button type="button" id="add-servico-btn" class="btn btn-primary btn-sm" disabled aria-label="Adicionar Serviço"><i class="fas fa-plus" aria-hidden="true"></i></button>
                            </div>
                        </div>
                        <h3>Serviços Adicionados <i class="fas fa-list-ul" aria-hidden="true"></i></h3>
                        <div class="data-list">
                            <ul id="orcamento-servicos-adicionados" style="min-height: 80px;" role="list">
                                <div class="empty-list-message" style="border: none; background: transparent; padding: 20px 0;">
                                    <p style="font-size: 1rem;"><i class="fas fa-info-circle" aria-hidden="true"></i> Nenhum serviço adicionado.</p>
                                    <small>Selecione um serviço acima e clique no '+' para adicionar.</small>
                                </div>
                            </ul>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="orcamento-desconto">Desconto (%)</label>
                            <input type="number" id="orcamento-desconto" value="0" min="0" max="100" placeholder="0-100" aria-label="Percentagem de Desconto">
                        </div>
                        <div class="form-group">
                            <label>Formas de Pagamento</label>
                            <div class="payment-options-group" id="payment-options" role="group" aria-label="Formas de Pagamento">
                                <button type="button" class="payment-option" data-value="Pix">Pix</button>
                                <button type="button" class="payment-option" data-value="Dinheiro">Dinheiro</button>
                                <button type="button" class="payment-option" data-value="Crédito">Crédito</button>
                                <button type="button" class="payment-option" data-value="Débito">Débito</button>
                                <button type="button" class="payment-option" data-value="Boleto">Boleto</button>
                            </div>
                            <span id="payment-options-validation" class="validation-message" aria-live="polite">Selecione ao menos uma forma de pagamento.</span>
                        </div>
                        <div id="orcamento-total" aria-live="polite">TOTAL: R$ 0,00</div>
                        <button type="submit" class="btn btn-primary" id="submit-orcamento-btn" aria-label="Salvar Orçamento"><i class="fas fa-save" aria-hidden="true"></i> Salvar Orçamento</button>
                        <button type="button" id="cancelar-edicao-orcamento" class="btn btn-secondary" style="display: none;" aria-label="Cancelar Edição do Orçamento"><i class="fas fa-times-circle" aria-hidden="true"></i> Cancelar Edição</button>
                    </form>
                </div>
            </section>

            <section id="historico-tab" class="tab-content" role="tabpanel">
                <div class="historico-layout">
                    <div class="card data-list">
                        <h2>Histórico de Serviços <i class="fas fa-folder-open" aria-hidden="true"></i></h2>
                        <div class="search-container">
                            <i class="fas fa-search" aria-hidden="true"></i>
                            <input type="search" id="search-historico" placeholder="Buscar por cliente, placa ou data..." aria-label="Pesquisar Histórico">
                        </div>
                        <div class="filter-options" role="group" aria-label="Opções de Filtro de Histórico">
                            <select id="filter-status" aria-label="Filtrar por Status">
                                <option value="">Todos os Status</option>
                                <option value="Orçamento">Orçamento</option>
                                <option value="Aprovado">Aprovado</option>
                                <option value="Finalizado">Finalizado</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                            <input type="date" id="filter-start-date" title="Data Inicial" aria-label="Data Inicial do Filtro">
                            <input type="date" id="filter-end-date" title="Data Final" aria-label="Data Final do Filtro">
                            <button id="clear-filters-btn" class="btn btn-sm btn-secondary" aria-label="Limpar Filtros"><i class="fas fa-broom"></i> Limpar</button>
                        </div>
                        <ul id="historico-lista" role="list">
                            </ul>
                    </div>
                    <div class="card" id="detalhes-orcamento-container" style="display: none;">
                        <h2>Detalhes do Serviço <i class="fas fa-info-circle" aria-hidden="true"></i></h2>
                        
                        <div class="detalhe-view-switcher" role="tablist" aria-label="Visualização de Detalhes do Orçamento">
                            <button id="btn-view-orcamento" class="detalhe-view-btn active" role="tab" aria-selected="true" aria-controls="detalhe-orcamento-bloco"><i class="fas fa-file-alt" aria-hidden="true"></i> Orçamento</button>
                            <button id="btn-view-recibo" class="detalhe-view-btn" style="display: none;" role="tab" aria-selected="false" aria-controls="detalhe-recibo-bloco"><i class="fas fa-receipt" aria-hidden="true"></i> Recibo</button>
                        </div>
                        
                        <div id="detalhe-orcamento-bloco" class="detalhe-bloco" role="tabpanel" aria-labelledby="btn-view-orcamento">
                           <h3>Texto do Orçamento <i class="fas fa-scroll" aria-hidden="true"></i></h3>
                           <pre id="detalhes-orcamento-texto" tabindex="0"></pre>
                           <div class="detalhe-bloco-actions">
                               <button id="btn-copiar-orcamento" class="btn btn-sm btn-secondary" aria-label="Copiar Texto do Orçamento"><i class="fas fa-copy" aria-hidden="true"></i> Copiar</button>
                               <button id="btn-whatsapp-orcamento" class="btn btn-sm btn-success" aria-label="Enviar Orçamento por WhatsApp"><i class="fab fa-whatsapp" aria-hidden="true"></i> WhatsApp</button>
                               <button id="btn-download-orcamento-pdf" class="btn btn-sm btn-secondary" aria-label="Baixar Orçamento em PDF"><i class="fas fa-file-pdf" aria-hidden="true"></i> Download PDF</button>
                           </div>
                        </div>

                        <div id="detalhe-recibo-bloco" class="detalhe-bloco" style="display: none;" role="tabpanel" aria-labelledby="btn-view-recibo">
                            <h3>Texto do Recibo de Serviço <i class="fas fa-money-bill-alt" aria-hidden="true"></i></h3>
                            <pre id="detalhes-recibo-texto" tabindex="0"></pre>
                            <div class="detalhe-bloco-actions">
                                <button id="btn-copiar-recibo" class="btn btn-sm btn-secondary" aria-label="Copiar Texto do Recibo"><i class="fas fa-copy" aria-hidden="true"></i> Copiar</button>
                                <button id="btn-whatsapp-recibo" class="btn btn-sm btn-success" aria-label="Enviar Recibo por WhatsApp"><i class="fab fa-whatsapp" aria-hidden="true"></i> WhatsApp</button>
                                <button id="btn-download-recibo-pdf" class="btn btn-sm btn-secondary" aria-label="Baixar Recibo em PDF"><i class="fas fa-file-pdf" aria-hidden="true"></i> Download PDF</button>
                           </div>
                        </div>

                        <div class="detalhes-status-actions" role="group" aria-label="Ações de Status do Serviço">
                             <button id="btn-edit-orcamento" class="btn btn-sm btn-secondary" aria-label="Editar Orçamento"><i class="fas fa-edit" aria-hidden="true"></i> Editar</button>
                             <button id="btn-aprovar" class="btn btn-sm" style="background-color: var(--accent-orange)" aria-label="Aprovar Orçamento"><i class="fas fa-thumbs-up" aria-hidden="true"></i> Aprovar</button>
                             <button id="btn-finalizar" class="btn btn-sm" style="background-color: var(--accent-green)" aria-label="Finalizar Serviço"><i class="fas fa-check-double" aria-hidden="true"></i> Finalizar</button>
                             <button id="btn-cancelar" class="btn btn-sm" style="background-color: var(--accent-red-status);" aria-label="Cancelar Orçamento"><i class="fas fa-times-circle" aria-hidden="true"></i> Cancelar</button>
                             <button id="btn-excluir-orcamento" class="btn btn-sm btn-danger" aria-label="Excluir Orçamento"><i class="fas fa-trash-alt" aria-hidden="true"></i> Excluir</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <div id="notification" role="status" aria-live="polite"></div>
    
    <div id="confirm-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <h3 id="modal-title">Confirmar Ação</h3>
            <p id="modal-message">Você tem certeza?</p>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="btn btn-secondary" aria-label="Cancelar"><i class="fas fa-ban" aria-hidden="true"></i> Cancelar</button>
                <button id="modal-confirm-btn" class="btn btn-danger" aria-label="Confirmar"><i class="fas fa-check-circle" aria-hidden="true"></i> Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="sync-overlay" role="alert" aria-live="assertive">
        <div class="sync-spinner"><i class="fas fa-sync-alt" aria-hidden="true"></i></div>
        <p>Sincronizando dados...</p>
    </div>

    <button id="back-to-top-btn" title="Voltar ao topo" aria-label="Voltar ao topo"><i class="fas fa-arrow-up" aria-hidden="true"></i></button>

    <script type="module">
        // ===================================================================================
        // DADOS DO ESTABELECIMENTO (ESTABLISHMENT DATA)
        // ===================================================================================
        const ESTABELECIMENTO = {
            nome: "R.M. Estética Automotiva",
            cnpj: "18.637.639/0001-48",
            telefone: "24999486232", // Only numbers for WhatsApp link
            endereco: "Rua 40, TV - Recanto dos Pássaros, Pq. Mambucaba, Angra dos Reis - RJ",
            agradecimento: "Obrigado pela preferência e volte sempre! 👍"
        };

        // ===================================================================================
        // SUPABASE CONFIGURATION
        // ===================================================================================
        const SUPABASE_URL = 'https://uymunsavnpfcsuznrugi.supabase.co';
        // !!! IMPORTANT: This is a public, anonymous key. It's safe to be in client-side code.
        // It allows 'anonymous' read/write access based on your Row Level Security (RLS) policies.
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5bXVuc2F2bnBmY3N1em5ydWdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3ODU3ODgsImV4cCI6MjA2NjM2MTc4OH0.Kz__-jB9SsD-w7SuwlYCWPuEOcOX9epRE9CB5jd4eFY'; 

        if (!SUPABASE_URL || !SUPABASE_KEY || SUPABASE_KEY.length < 50) {
            document.body.innerHTML = `
                <div style="padding: 40px; text-align: center; font-size: 1.2rem; color: #ffcc00; background-color: #333; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <h1><i class="fas fa-exclamation-triangle" aria-hidden="true" style="color: orange;"></i> Erro de Configuração Crítico</h1>
                    <p>As credenciais do Supabase não foram encontradas ou estão incorretas.</p>
                    <p style="font-size: 0.9rem; color: #bbb;">Por favor, verifique as constantes SUPABASE_URL e SUPABASE_KEY no código-fonte.</p>
                </div>`;
            throw new Error("Supabase credentials not configured. Please check SUPABASE_URL and SUPABASE_KEY constants.");
        }

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ===================================================================================
        // APPLICATION LOGIC START
        // ===================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Global state object to manage application data
            let state = {
                clientes: [], 
                servicos: [], 
                orcamentos: [],
                editandoClienteId: null, 
                editandoServicoId: null,
                editandoOrcamentoId: null,
                novoOrcamentoItens: [], 
                orcamentoSelecionado: null,
                isSyncing: false,
                isOffline: !navigator.onLine, 
                supabaseListeners: [],
                chartInstance: null
            };

            // DOM Element Selectors for frequently accessed elements
            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);

            // Cached DOM elements
            const syncBtn = $('#sync-btn');
            const notification = $('#notification');
            const syncOverlay = $('#sync-overlay');
            const backToTopBtn = $('#back-to-top-btn'); 
            const offlineIndicator = $('#offline-indicator');

            // Cliente tab elements
            const clienteForm = $('#cliente-form');
            const clientesLista = $('#clientes-lista');
            const searchClienteInput = $('#search-cliente');
            const clienteTelefoneInput = $('#cliente-telefone');
            const clienteNomeInput = $('#cliente-nome');
            const clienteCarroInput = $('#cliente-carro');
            const clientePlacaInput = $('#cliente-placa'); 
            const sortClientesSelect = $('#sort-clientes');
            const clientDetailsPanel = $('#client-details-panel');
            const closeClientDetailsBtn = $('.close-details-btn');

            // Serviço tab elements
            const servicoForm = $('#servico-form');
            const servicosLista = $('#servicos-lista');
            const searchServicoInput = $('#search-servico');
            const servicoDescricaoInput = $('#servico-descricao');
            const servicoValorInput = $('#servico-valor');
            const sortServicosSelect = $('#sort-servicos');

            // Novo Orçamento tab elements
            const orcamentoForm = $('#orcamento-form');
            const orcamentoIdToEditInput = $('#orcamento-id-to-edit'); 
            const orcamentoFormTitle = $('#orcamento-form-title');
            const orcamentoClienteSelect = $('#orcamento-cliente');
            const orcamentoServicoSelect = $('#orcamento-servico-select'); 
            const orcamentoServicoQuantidadeInput = $('#orcamento-servico-quantidade'); 
            const addServicoBtn = $('#add-servico-btn');
            const orcamentoServicosAdicionados = $('#orcamento-servicos-adicionados');
            const orcamentoDescontoInput = $('#orcamento-desconto');
            const orcamentoTotalDiv = $('#orcamento-total');
            const paymentOptionsContainer = $('#payment-options');
            const paymentOptionsValidation = $('#payment-options-validation');
            const submitOrcamentoBtn = $('#submit-orcamento-btn');
            const cancelarEdicaoOrcamentoBtn = $('#cancelar-edicao-orcamento');

            // Histórico tab elements
            const historicoLista = $('#historico-lista');
            const searchHistoricoInput = $('#search-historico');
            const filterStatusSelect = $('#filter-status');
            const filterStartDateInput = $('#filter-start-date');
            const filterEndDateInput = $('#filter-end-date');
            const clearFiltersBtn = $('#clear-filters-btn');
            const detalhesContainer = $('#detalhes-orcamento-container');
            const recentActivityList = $('#recent-activity-list');

            // Modal elements
            const confirmModal = $('#confirm-modal'); 
            const modalConfirmBtn = $('#modal-confirm-btn'); 
            const modalCancelBtn = $('#modal-cancel-btn'); 
            let onConfirmCallback = null; 

            // Debounce function
            const debounce = (func, delay) => {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            };

            // ===================================================================================
            // UTILITY FUNCTIONS
            // ===================================================================================

            /**
             * Displays a temporary notification message.
             * @param {string} message - The message to display.
             * @param {'success' | 'error' | 'warning'} type - The type of notification (influences color).
             */
            const showNotification = (message, type = 'success') => { 
                notification.textContent = message; 
                notification.className = `show ${type}`; 
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000); 
            };

            /**
             * Triggers a confetti animation at the center of the screen.
             * @param {'success' | 'warning'} type - Determines confetti color.
             */
            const triggerConfetti = (type = 'success') => {
                const colors = type === 'success' 
                    ? ['#22c55e', '#10b981', '#34d399', '#6ee7b7'] // Greenish
                    : ['#f97316', '#fb923c', '#fdba74', '#fed7aa']; // Orangish
                
                const count = 30; // Number of confetti particles
                for (let i = 0; i < count; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.color = color;
                    
                    const startX = window.innerWidth / 2;
                    const startY = window.innerHeight / 2;
                    const endX = (Math.random() - 0.5) * 800;
                    const endY = (Math.random() * window.innerHeight * 0.7) + (window.innerHeight * 0.1);

                    confetti.style.left = `${startX}px`;
                    confetti.style.top = `${startY}px`;
                    confetti.style.setProperty('--x', `${endX}px`);
                    confetti.style.setProperty('--y', `${endY}px`);
                    
                    confetti.style.animationDelay = `${Math.random() * 0.2}s`;
                    
                    document.body.appendChild(confetti);
                    confetti.addEventListener('animationend', () => confetti.remove());
                }
            };
            
            /**
             * Switches the active tab view.
             * @param {string} tabId - The ID of the tab to activate (e.g., 'dashboard', 'clientes').
             * @param {Object} [filterParams={}] - Optional parameters to apply filters on the target tab.
             */
            const showTab = (tabId, filterParams = {}) => { 
                $$('.tab-content').forEach(t => t.classList.remove('active')); 
                $$('.nav-btn').forEach(b => b.classList.remove('active')); 
                $(`#${tabId}-tab`)?.classList.add('active'); 
                $(`.nav-btn[data-tab="${tabId}"]`)?.classList.add('active'); 
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Apply filters if navigating to historico tab
                if (tabId === 'historico') {
                    if (filterStatusSelect) filterStatusSelect.value = filterParams.status || '';
                    if (filterStartDateInput) filterStartDateInput.value = filterParams.startDate || '';
                    if (filterEndDateInput) filterEndDateInput.value = filterParams.endDate || '';
                    renderOrcamentos(); // Re-render with new filters
                } 
                
                // Close client details panel if not on clients tab
                if (tabId !== 'clientes' && clientDetailsPanel) {
                    clientDetailsPanel.style.display = 'none';
                }
            };

            /**
             * Formats a number as Brazilian currency.
             * @param {number} value - The number to format.
             * @returns {string} - The formatted currency string.
             */
            const formatCurrency = (value) => 
                value != null ? parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';

            /**
             * Formats a date string into a Brazilian locale date/time.
             * @param {string} dateString - The date string to format.
             * @returns {string} - The formatted date/time string.
             */
            const formatDateTime = (dateString) => 
                dateString ? new Date(dateString).toLocaleString('pt-BR', {timeZone: 'America/Sao_Paulo', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}) : 'N/A';
            
            /**
             * Formats a raw phone number into a readable (XX) XXXXX-XXXX format.
             * @param {string} value - The phone number string.
             * @returns {string} - The formatted phone number.
             */
            const formatPhone = (value) => {
                if (!value) return "";
                let v = value.replace(/\D/g, '').slice(0, 11);
                if (v.length > 10) {
                    // 11 digits (mobile with 9)
                    v = v.replace(/^(\d\d)(\d{5})(\d{4}).*/, '($1) $2-$3');
                } else if (v.length > 6) {
                    // 10 digits (mobile with 8 or landline)
                    v = v.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, '($1) $2-$3');
                } else if (v.length > 2) {
                    v = v.replace(/^(\d\d)(\d{0,5}).*/, '($1) $2');
                } else if (v.length > 0) {
                    v = v.replace(/^(\d*)/, '($1');
                }
                return v;
            };
            
             /**
             * Formats a raw license plate into a readable format.
             * @param {string} value - The license plate string.
             * @returns {string} - The formatted license plate.
             */
            const formatPlaca = (value) => {
                if (!value) return 'N/D';
                value = value.toUpperCase();
                // Old format: ABC1234 -> ABC-1234
                if (value.length === 7 && /^[A-Z]{3}\d{4}$/.test(value)) {
                    return value.replace(/(\w{3})(\w{4})/, '$1-$2');
                }
                // Mercosul format: ABC1D23 remains as is
                return value;
            };

            /**
             * Cleans a phone number for WhatsApp URL (removes non-digits, adds 55 for Brazil).
             * @param {string} value - The phone number string.
             * @returns {string | null} - The cleaned phone number or null.
             */
            const cleanPhone = (value) => value ? `55${value.replace(/\D/g, '')}` : null;

            /**
             * Shows the confirmation modal.
             * @param {string} title - The title of the modal.
             * @param {string} message - The message to display.
             * @param {function} callback - The function to call if confirmed.
             */
            const showConfirmModal = (title, message, callback) => { 
                $('#modal-title').textContent = title; 
                $('#modal-message').textContent = message; 
                onConfirmCallback = callback; 
                confirmModal.classList.add('active'); 
            };

            /** Hides the confirmation modal. */
            const hideConfirmModal = () => { 
                confirmModal.classList.remove('active'); 
                onConfirmCallback = null; 
            };

            /**
             * Generates HTML for an empty list message.
             * @param {string} message - Main message.
             * @param {string} suggestion - Suggestion text.
             * @returns {string} HTML for the empty list message.
             */
            const renderEmptyState = (message, suggestion) => `
                <div class="empty-list-message">
                    <p><i class="fas fa-info-circle"></i> ${message}</p>
                    <small>${suggestion}</small>
                </div>
            `;

            /**
             * Displays skeleton loaders in a target element.
             * @param {HTMLElement} targetElement - The element to fill with skeletons.
             * @param {number} count - Number of skeleton items.
             * @param {string} type - 'list', 'stat-card', or 'chart'.
             */
            const showSkeletons = (targetElement, count, type = 'list') => {
                if (!targetElement) return;
                let html = '';
                if (type === 'chart') {
                    html = `<div class="skeleton-loading-chart skeleton-loading"></div>`;
                } else {
                    for (let i = 0; i < count; i++) {
                        if (type === 'list') {
                            html += `<li class="skeleton-loading-list-item skeleton-loading"></li>`;
                        } else if (type === 'stat-card') {
                            html += `<div class="stat-card skeleton-loading-stat-card skeleton-loading"></div>`;
                        }
                    }
                }
                targetElement.innerHTML = html;
            };
            
            /**
             * Exports data to a CSV file.
             * @param {Array<Object>} data - The array of objects to export.
             * @param {string} filename - The name of the CSV file.
             */
            const exportToCsv = (data, filename) => {
                if (!data || data.length === 0) {
                    showNotification('Nenhum dado para exportar.', 'warning');
                    return;
                }

                const headers = Object.keys(data[0]).filter(key => 
                    !['created_at', 'updated_at', 'deleted_at', 'id', 'cliente_id'].includes(key) &&
                    typeof data[0][key] !== 'object' 
                );
                
                const csvRows = [];
                csvRows.push(headers.join(',')); 

                for (const row of data) {
                    const values = headers.map(header => {
                        const escaped = ('' + row[header]).replace(/"/g, '""');
                        return `"${escaped}"`;
                    });
                    csvRows.push(values.join(','));
                }

                const blob = new Blob([`\uFEFF${csvRows.join('\n')}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification('Dados exportados para CSV!', 'success');
            };

            /**
             * Manages validation icons for form inputs.
             * @param {HTMLInputElement} inputElement - The input element.
             */
            const handleValidationIcon = (inputElement) => {
                const formGroup = inputElement.closest('.form-group');
                if (!formGroup) return;
                const icon = formGroup.querySelector('.validation-icon');
                if (!icon) return;

                if (inputElement.value.trim() === '' && inputElement.required) {
                    icon.className = 'validation-icon fas';
                    return;
                }
                
                if (inputElement.checkValidity()) {
                    icon.className = 'validation-icon fas fa-check-circle';
                } else {
                    icon.className = 'validation-icon fas fa-times-circle';
                }
            };


            // ===================================================================================
            // REAL-TIME DATA SUBSCRIPTIONS & SYNCING
            // ===================================================================================

            /**
             * Initializes Supabase real-time listeners for all main collections.
             */
            const setupSupabaseListeners = () => {
                const handlePayload = (payload) => {
                    console.log('Real-time change received:', payload);
                    fetchAllData(false); // Refetch all data silently on any change
                };

                const tables = ['clientes', 'servicos', 'orcamentos', 'orcamento_itens'];
                tables.forEach(table => {
                    const channel = db.channel(`public:${table}`)
                        .on('postgres_changes', { event: '*', schema: 'public', table: table }, handlePayload)
                        .subscribe((status, err) => {
                            if (status === 'SUBSCRIBED') {
                                console.log(`Subscribed to ${table} changes.`);
                            }
                            if (err) {
                                console.error(`Error subscribing to ${table}:`, err);
                            }
                        });
                    state.supabaseListeners.push(channel);
                });
            };

            /**
             * Manages the network status indicator and triggers data sync on reconnection.
             */
            const updateNetworkStatus = () => {
                state.isOffline = !navigator.onLine;
                offlineIndicator.style.display = state.isOffline ? 'block' : 'none';
                if (!state.isOffline) {
                    showNotification('Conectado novamente! Sincronizando dados...', 'success');
                    fetchAllData(true); 
                } else {
                    showNotification('Você está offline. As alterações não serão salvas.', 'error');
                }
            };


            // ===================================================================================
            // DATA FETCHING & RENDERING
            // ===================================================================================

            /**
             * Fetches all necessary data from Supabase and updates the UI.
             * @param {boolean} [showLoadingOverlay=true] - Whether to show the full sync overlay.
             */
            const fetchAllData = async (showLoadingOverlay = true) => {
                if (state.isSyncing) return; 

                state.isSyncing = true;
                syncBtn.classList.add('syncing');
                if (showLoadingOverlay) {
                    syncOverlay.style.display = 'flex'; 
                }
                
                if (!state.clientes.length) renderSkeletons(); // Show skeletons only on initial load

                try {
                    const [clientesRes, servicosRes, orcamentosRes] = await Promise.all([
                        db.from('clientes').select('*'),
                        db.from('servicos').select('*'),
                        db.from('orcamentos').select(`
                            id, created_at, updated_at, valor_total, status, desconto, formas_pagamento, 
                            cliente_id,
                            clientes ( id, nome, carro, telefone, placa ), 
                            orcamento_itens ( id, servico_id, descricao_servico, valor_cobrado, quantidade )
                        `).order('created_at', { ascending: false })
                    ]);

                    if (clientesRes.error) throw new Error(`Clientes: ${clientesRes.error.message}`);
                    if (servicosRes.error) throw new Error(`Serviços: ${servicosRes.error.message}`);
                    if (orcamentosRes.error) throw new Error(`Orçamentos: ${orcamentosRes.error.message}`);
                    
                    state.clientes = clientesRes.data;
                    state.servicos = servicosRes.data;
                    state.orcamentos = orcamentosRes.data;
                    
                    renderAllContent(); 
                    if (showLoadingOverlay) { 
                        showNotification('Dados sincronizados!', 'success');
                    }
                } catch (error) {
                    console.error('Fetch all data error:', error);
                    showNotification(`Falha ao sincronizar: ${error.message}`, 'error');
                    renderEmptyStatesOnFailure(); 
                } finally {
                    state.isSyncing = false;
                    syncBtn.classList.remove('syncing');
                    if (showLoadingOverlay) {
                        syncOverlay.style.display = 'none'; 
                    }
                }
            };

            /** Renders all major sections of the UI with current state data. */
            const renderAllContent = () => {
                renderClientes(); 
                renderServicos(); 
                renderOrcamentos(); 
                renderOrcamentoClienteOptions(); 
                renderOrcamentoServicoOptions(); 
                updateDashboard(); 
                renderRecentActivity(); 

                // Re-select the budget if it still exists
                if (state.orcamentoSelecionado) {
                    const updatedOrcamento = state.orcamentos.find(o => o.id === state.orcamentoSelecionado.id);
                    if (updatedOrcamento) {
                        state.orcamentoSelecionado = updatedOrcamento;
                        displayOrcamentoDetails();
                    } else {
                        state.orcamentoSelecionado = null;
                        detalhesContainer.style.display = 'none';
                    }
                }
            };
            
            /** Displays skeleton loaders in all relevant sections on first load. */
            const renderSkeletons = () => {
                $$('.stat-card p').forEach(p => {
                    if(p) p.innerHTML = '<div class="skeleton-loading-text skeleton-loading" style="height: 2rem; width: 60%; margin: auto;"></div>'
                });
                showSkeletons($('#recent-activity-list'), 3, 'list');
                showSkeletons(clientesLista, 4, 'list');
                showSkeletons(servicosLista, 4, 'list');
                showSkeletons(historicoLista, 4, 'list');
                
                orcamentoClienteSelect.innerHTML = '<option>Carregando...</option>';
                orcamentoServicoSelect.innerHTML = '<option>Carregando...</option>';
            };

            /** Displays empty states if data fetching fails. */
            const renderEmptyStatesOnFailure = () => {
                if (clientesLista) clientesLista.innerHTML = renderEmptyState('Não foi possível carregar os clientes.', 'Verifique sua conexão e tente sincronizar.');
                if (servicosLista) servicosLista.innerHTML = renderEmptyState('Não foi possível carregar os serviços.', 'Verifique sua conexão e tente sincronizar.');
                if (historicoLista) historicoLista.innerHTML = renderEmptyState('Não foi possível carregar o histórico.', 'Verifique sua conexão e tente sincronizar.');
                if (recentActivityList) recentActivityList.innerHTML = renderEmptyState('Não foi possível carregar a atividade recente.', 'Verifique sua conexão.');
            };

            // ===================================================================================
            // DASHBOARD LOGIC
            // ===================================================================================

            /** Updates the dashboard statistics and chart. */
            const updateDashboard = () => {
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                
                const totalRevenue = state.orcamentos
                    .filter(o => o.status === 'Finalizado')
                    .reduce((sum, o) => sum + parseFloat(o.valor_total || 0), 0);
                
                const statClientes = $('#stat-clientes');
                if (statClientes) statClientes.textContent = state.clientes.length;

                const statPendentes = $('#stat-pendentes');
                if (statPendentes) statPendentes.textContent = state.orcamentos.filter(o => o.status === 'Orçamento').length;
                
                const statAprovados = $('#stat-aprovados');
                if (statAprovados) statAprovados.textContent = state.orcamentos.filter(o => o.status === 'Aprovado').length;
                
                const statFinalizadosMes = $('#stat-finalizados-mes');
                if (statFinalizadosMes) statFinalizadosMes.textContent = state.orcamentos.filter(o => o.status === 'Finalizado' && new Date(o.updated_at || o.created_at) >= startOfMonth).length;
                
                const statFaturamentoTotal = $('#stat-faturamento-total');
                if (statFaturamentoTotal) statFaturamentoTotal.textContent = formatCurrency(totalRevenue);

                renderMonthlyStatsChart();
            };
            
            /** Renders the bar chart for monthly finalized services using Chart.js. */
            const renderMonthlyStatsChart = () => {
                const chartContainer = $('#monthly-stats-chart');
                if (!chartContainer) {
                    console.warn('Chart container #monthly-stats-chart not found.');
                    return;
                }

                // --- 1. Data Aggregation using YYYY-MM keys for robustness ---
                const monthlyData = {};
                const now = new Date();

                // Initialize the last 6 months with 0 count
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const monthKey = date.toISOString().slice(0, 7); // "YYYY-MM" format
                    monthlyData[monthKey] = 0;
                }

                // Aggregate data from orcamentos
                state.orcamentos.forEach(orc => {
                    if (orc.status === 'Finalizado' && orc.updated_at) {
                        const orcDate = new Date(orc.updated_at);
                        const orcMonthKey = orcDate.toISOString().slice(0, 7); // "YYYY-MM"
                        if (monthlyData.hasOwnProperty(orcMonthKey)) {
                            monthlyData[orcMonthKey]++;
                        }
                    }
                });

                // --- 2. Prepare Chart Data & Labels ---
                const chartLabels = Object.keys(monthlyData).map(monthKey => {
                    const [year, month] = monthKey.split('-');
                    return new Date(year, month - 1, 1).toLocaleString('pt-BR', { month: 'short' });
                });
                const chartData = Object.values(monthlyData);

                // --- 3. Render or Update Chart ---
                if (state.chartInstance) {
                    // If chart exists, just update its data.
                    state.chartInstance.data.labels = chartLabels;
                    state.chartInstance.data.datasets[0].data = chartData;
                    state.chartInstance.update();
                } else {
                    // If chart does not exist, create it
                    chartContainer.innerHTML = ''; // Clear skeleton/previous content
                    const canvas = document.createElement('canvas');
                    canvas.id = 'monthlyFinalizedChartCanvas';
                    chartContainer.appendChild(canvas);
                    const ctx = canvas.getContext('2d');
                    
                    state.chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: 'Serviços Finalizados',
                                data: chartData,
                                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                                borderColor: 'rgba(22, 163, 74, 1)',
                                borderWidth: 1,
                                borderRadius: 5,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#94a3b8',
                                        precision: 0 
                                    },
                                    grid: { color: '#475569', drawBorder: false },
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { display: false },
                                }
                            }
                        }
                    });
                }
            };

            /** Renders a list of recent activities. */
            const renderRecentActivity = () => {
                const sorted = [...state.orcamentos].sort((a, b) => new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at));
                const recent = sorted.slice(0, 8);

                if (recent.length === 0) {
                    recentActivityList.innerHTML = renderEmptyState('Nenhuma atividade recente.', 'Crie um novo orçamento para começar.');
                    return;
                }
                recentActivityList.innerHTML = recent.map(orc => `
                    <li data-id="${orc.id}" class="data-list-item" tabindex="0">
                        <div>
                            <strong>${orc.clientes?.nome || 'Cliente Removido'}</strong><br>
                            <small>${formatDateTime(orc.updated_at || orc.created_at)}</small>
                        </div>
                        <div>
                            <span class="status-indicator status-${orc.status}">${orc.status}</span>
                        </div>
                    </li>
                `).join('');
            };

            // ===================================================================================
            // CLIENTS TAB LOGIC
            // ===================================================================================

            /** Renders the list of clients based on search and sort criteria. */
            const renderClientes = () => {
                const searchTerm = searchClienteInput.value.toLowerCase().trim();
                let filtered = state.clientes.filter(c => 
                    c.nome.toLowerCase().includes(searchTerm) || 
                    (c.placa && c.placa.toLowerCase().includes(searchTerm))
                );
                
                // Apply sorting
                const [key, order] = sortClientesSelect.value.split('_');
                filtered.sort((a, b) => {
                    const valA = a[key] || '';
                    const valB = b[key] || '';
                    const comparison = valA.localeCompare(valB, 'pt-BR', { sensitivity: 'base' });
                    return order === 'asc' ? comparison : -comparison;
                });

                if (filtered.length === 0) {
                    clientesLista.innerHTML = renderEmptyState('Nenhum cliente encontrado.', searchTerm ? 'Tente um termo de busca diferente.' : 'Adicione um novo cliente no formulário.');
                    return;
                }
                
                clientesLista.innerHTML = filtered.map(c => `
                    <li data-id="${c.id}" class="data-list-item" role="listitem">
                        <div class="client-info-wrapper" data-id="${c.id}" tabindex="0" role="button">
                            <strong data-field="nome">${c.nome}</strong>
                            <input type="text" class="inline-edit-input edit-mode-input" data-field="nome" value="${c.nome || ''}" style="display:none;">
                            <br>
                            <small>
                                <i class="fas fa-car" aria-hidden="true"></i> <span data-field="carro">${c.carro || 'N/D'}</span>
                                | <i class="fas fa-id-card" aria-hidden="true"></i> <span data-field="placa">${formatPlaca(c.placa)}</span>
                            </small>
                            <input type="text" class="inline-edit-input edit-mode-input" data-field="carro" value="${c.carro || ''}" placeholder="Veículo" style="display:none; margin-top: 5px;">
                            <input type="tel" class="inline-edit-input edit-mode-input" data-field="telefone" value="${formatPhone(c.telefone)}" placeholder="Telefone" style="display:none; margin-top: 5px;">
                            <input type="text" class="inline-edit-input edit-mode-input" data-field="placa" value="${c.placa || ''}" placeholder="Placa" style="display:none; margin-top: 5px;">
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-sm btn-secondary edit-cliente-btn" data-id="${c.id}" title="Editar Cliente"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger delete-cliente-btn" data-id="${c.id}" title="Excluir Cliente"><i class="fas fa-trash-alt"></i></button>
                            <button class="btn btn-sm btn-success save-inline-edit-btn edit-mode-input" data-id="${c.id}" style="display: none;"><i class="fas fa-save"></i> Guardar</button>
                            <button class="btn btn-sm btn-secondary cancel-inline-edit-btn edit-mode-input" data-id="${c.id}" style="display: none;"><i class="fas fa-times"></i> Cancelar</button>
                        </div>
                    </li>
                `).join('');
            };

            /** Handles client form submission for adding a NEW client. */
            const handleClienteSubmit = async (e) => { 
                e.preventDefault(); 
                if (!clienteForm.checkValidity()) {
                    clienteForm.reportValidity();
                    showNotification('Por favor, preencha os campos obrigatórios corretamente.', 'warning');
                    return;
                }

                const data = { 
                    nome: clienteNomeInput.value.trim(), 
                    telefone: clienteTelefoneInput.value.replace(/\D/g, ''), 
                    carro: clienteCarroInput.value.trim(), 
                    placa: clientePlacaInput.value.trim().toUpperCase().replace(/[^A-Z0-9]/g, '') 
                }; 

                try {
                    const { error } = await db.from('clientes').insert(data);
                    if (error) throw error;
                    showNotification(`Cliente cadastrado com sucesso!`, 'success'); 
                    triggerConfetti('success');
                    resetClienteForm(); 
                } catch (err) {
                    console.error('Erro ao salvar cliente:', err);
                    showNotification(`Erro ao salvar cliente: ${err.message}`, 'error');
                }
            };
            
            /** Toggles a client list item into inline editing mode. */
            const toggleClienteEditMode = (id, forceClose = false) => {
                // Close any other editing rows first
                $$('#clientes-lista li.editing').forEach(otherRow => {
                    if (otherRow.dataset.id !== id) {
                        toggleClienteEditMode(otherRow.dataset.id, true);
                    }
                });

                const listItem = $(`#clientes-lista li[data-id="${id}"]`);
                if (!listItem) return;

                const isEditing = listItem.classList.contains('editing');
                if (forceClose || isEditing) {
                    // Revert to view mode
                    listItem.classList.remove('editing');
                    listItem.querySelectorAll('.edit-mode-input').forEach(el => el.style.display = 'none');
                    listItem.querySelectorAll('[data-field]').forEach(el => el.style.display = 'inline');
                    listItem.querySelectorAll('.item-actions .btn:not(.edit-mode-input)').forEach(el => el.style.display = 'inline-flex');
                } else {
                    // Enter edit mode
                    listItem.classList.add('editing');
                    const client = state.clientes.find(c => c.id == id);
                    if (!client) return;

                    // Populate and show inputs
                    listItem.querySelectorAll('.edit-mode-input').forEach(el => {
                        el.style.display = 'inline-block';
                        const fieldName = el.dataset.field;
                        let fieldValue = client[fieldName] || '';
                        if (fieldName === 'telefone') {
                           fieldValue = formatPhone(fieldValue);
                        }
                        el.value = fieldValue;
                    });
                    
                    // Hide spans and default buttons
                    listItem.querySelectorAll('[data-field]').forEach(el => el.style.display = 'none');
                    listItem.querySelectorAll('.item-actions .btn:not(.edit-mode-input)').forEach(el => el.style.display = 'none');
                }
            };
            
            /** Saves the inline edits for a client. */
            const handleSaveInlineEditCliente = async (id) => {
                const listItem = $(`#clientes-lista li[data-id="${id}"]`);
                const data = {
                    nome: listItem.querySelector('[data-field="nome"].edit-mode-input').value.trim(),
                    carro: listItem.querySelector('[data-field="carro"].edit-mode-input').value.trim(),
                    telefone: listItem.querySelector('[data-field="telefone"].edit-mode-input').value.replace(/\D/g, ''),
                    placa: listItem.querySelector('[data-field="placa"].edit-mode-input').value.trim().toUpperCase().replace(/[^A-Z0-9]/g, '')
                };

                if (!data.nome) {
                    showNotification('O nome do cliente não pode ser vazio.', 'error');
                    return;
                }

                try {
                    const { error } = await db.from('clientes').update(data).eq('id', id);
                    if (error) throw error;
                    showNotification('Cliente atualizado!', 'success');
                    // The real-time listener will handle the re-render, so just close the edit mode
                    toggleClienteEditMode(id, true);
                } catch (err) {
                    console.error('Erro ao atualizar cliente:', err);
                    showNotification(`Erro ao atualizar: ${err.message}`, 'error');
                }
            };

            /** Initiates deletion of a client after confirmation. */
            const handleDeleteCliente = (id) => showConfirmModal(
                'Excluir Cliente', 
                'Esta ação é irreversível e irá apagar também todos os orçamentos vinculados a este cliente. Deseja continuar?', 
                async () => { 
                    try {
                        const { error } = await db.from('clientes').delete().eq('id', id); 
                        if (error) throw error; 
                        showNotification('Cliente excluído com sucesso!', 'success'); 
                        triggerConfetti('success');
                        clientDetailsPanel.style.display = 'none'; // Hide details if this client was shown
                    } catch (err) {
                        console.error('Erro ao excluir cliente:', err);
                        showNotification(`Erro ao excluir cliente: ${err.message}`, 'error'); 
                    }
                }
            );

            /** Resets the client form to its initial state. */
            const resetClienteForm = () => { 
                state.editandoClienteId = null; 
                clienteForm.reset(); 
                $('#cliente-form-title').innerHTML = 'Novo Cliente <i class="fas fa-user-plus" aria-hidden="true"></i>'; 
                $('#cancelar-edicao-cliente').style.display = 'none'; 
                $$('#cliente-form .validation-icon').forEach(icon => icon.className = 'validation-icon fas');
            };

            /** Displays detailed information for a selected client. */
            const displayClientDetails = async (clientId) => {
                const client = state.clientes.find(c => c.id === clientId);
                if (!client) {
                    showNotification('Cliente não encontrado.', 'error');
                    return;
                }

                $('#client-detail-name').textContent = client.nome;
                $('#client-detail-phone').textContent = formatPhone(client.telefone);
                $('#client-detail-car').textContent = client.carro || 'N/D';
                $('#client-detail-plate').textContent = formatPlaca(client.placa);

                const pastOrcamentosList = $('#client-past-orcamentos');
                pastOrcamentosList.innerHTML = '<li>Carregando histórico...</li>';

                const clientOrcamentos = state.orcamentos.filter(o => o.cliente_id === clientId);
                
                if (clientOrcamentos.length === 0) {
                    pastOrcamentosList.innerHTML = renderEmptyState('Nenhum serviço anterior para este cliente.', '');
                } else {
                    pastOrcamentosList.innerHTML = clientOrcamentos.map(orc => `
                        <li data-id="${orc.id}" tabindex="0" role="button">
                            <div>
                                <strong>${formatDateTime(orc.created_at)}</strong><br>
                                <small>${orc.orcamento_itens.map(item => item.descricao_servico).join(', ')}</small>
                            </div>
                            <div>
                                <span class="status-indicator status-${orc.status}">${orc.status}</span>
                                <strong>${formatCurrency(orc.valor_total)}</strong>
                            </div>
                        </li>
                    `).join('');
                }
                
                clientDetailsPanel.style.display = 'block';
                clientDetailsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            };
            
            // ===================================================================================
            // SERVICES TAB LOGIC
            // ===================================================================================

            /** Renders the list of services based on search and sort criteria. */
            const renderServicos = () => {
                const searchTerm = searchServicoInput.value.toLowerCase().trim();
                let filtered = state.servicos.filter(s => s.descricao.toLowerCase().includes(searchTerm));

                const [key, order] = sortServicosSelect.value.split('_');
                filtered.sort((a, b) => {
                    let valA = a[key];
                    let valB = b[key];
                    if(key === 'valor'){
                        return order === 'asc' ? valA - valB : valB - valA;
                    }
                    const comparison = String(valA).localeCompare(String(valB), 'pt-BR', { sensitivity: 'base' });
                    return order === 'asc' ? comparison : -comparison;
                });
                
                if (filtered.length === 0) {
                    servicosLista.innerHTML = renderEmptyState('Nenhum serviço encontrado.', searchTerm ? 'Tente um termo de busca diferente.' : 'Adicione um novo serviço no formulário.');
                    return;
                }

                servicosLista.innerHTML = filtered.map(s => `
                    <li data-id="${s.id}" class="data-list-item">
                        <div>
                            <strong data-field="descricao">${s.descricao}</strong>
                            <input type="text" class="inline-edit-input edit-mode-input" data-field="descricao" value="${s.descricao}" style="display:none;">
                            <br>
                            <small>
                                R$ <span data-field="valor">${s.valor.toFixed(2).replace('.', ',')}</span>
                            </small>
                             <input type="number" step="0.01" class="inline-edit-input edit-mode-input" data-field="valor" value="${s.valor}" style="display:none; margin-top: 5px;">
                        </div>
                        <div class="item-actions">
                             <button class="btn btn-sm btn-secondary edit-servico-btn" data-id="${s.id}" title="Editar Serviço"><i class="fas fa-edit"></i></button>
                             <button class="btn btn-sm btn-danger delete-servico-btn" data-id="${s.id}" title="Excluir Serviço"><i class="fas fa-trash-alt"></i></button>
                             <button class="btn btn-sm btn-success save-inline-edit-btn" data-id="${s.id}" style="display: none;"><i class="fas fa-save"></i> Guardar</button>
                             <button class="btn btn-sm btn-secondary cancel-inline-edit-btn" data-id="${s.id}" style="display: none;"><i class="fas fa-times"></i> Cancelar</button>
                        </div>
                    </li>
                `).join('');
            };

            /** Handles service form submission for adding a NEW service. */
            const handleServicoSubmit = async (e) => { 
                e.preventDefault(); 
                if (!servicoForm.checkValidity()) {
                    servicoForm.reportValidity();
                    showNotification('Por favor, preencha os campos obrigatórios corretamente.', 'warning');
                    return;
                }
                const data = { 
                    descricao: servicoDescricaoInput.value.trim(), 
                    valor: parseFloat(servicoValorInput.value) 
                }; 
                try {
                    const { error } = await db.from('servicos').insert(data);
                    if (error) throw error;
                    showNotification(`Serviço cadastrado com sucesso!`, 'success'); 
                    triggerConfetti('success');
                    resetServicoForm(); 
                } catch (err) {
                    console.error('Erro ao salvar serviço:', err);
                    showNotification(`Erro ao salvar serviço: ${err.message}`, 'error'); 
                }
            };
            
            /** Toggles a service list item into inline editing mode. */
            const toggleServicoEditMode = (id, forceClose = false) => {
                $$('#servicos-lista li.editing').forEach(otherRow => {
                    if (otherRow.dataset.id !== id) {
                        toggleServicoEditMode(otherRow.dataset.id, true);
                    }
                });

                const listItem = $(`#servicos-lista li[data-id="${id}"]`);
                if (!listItem) return;

                const isEditing = listItem.classList.contains('editing');
                if (forceClose || isEditing) {
                    listItem.classList.remove('editing');
                    listItem.querySelectorAll('.edit-mode-input').forEach(el => el.style.display = 'none');
                    listItem.querySelectorAll('[data-field]').forEach(el => el.style.display = 'inline');
                    listItem.querySelectorAll('.item-actions .btn:not(.edit-mode-input)').forEach(el => el.style.display = 'inline-flex');
                } else {
                    listItem.classList.add('editing');
                    const servico = state.servicos.find(s => s.id == id);
                    if (!servico) return;

                    listItem.querySelectorAll('.edit-mode-input').forEach(el => {
                        el.style.display = 'inline-block';
                        el.value = servico[el.dataset.field];
                    });
                    
                    listItem.querySelectorAll('[data-field]').forEach(el => el.style.display = 'none');
                    listItem.querySelectorAll('.item-actions .btn:not(.edit-mode-input)').forEach(el => el.style.display = 'none');
                }
            };
            
            /** Saves the inline edits for a service. */
            const handleSaveInlineEditServico = async (id) => {
                const listItem = $(`#servicos-lista li[data-id="${id}"]`);
                const data = {
                    descricao: listItem.querySelector('[data-field="descricao"].edit-mode-input').value.trim(),
                    valor: parseFloat(listItem.querySelector('[data-field="valor"].edit-mode-input').value)
                };

                if (!data.descricao || !data.valor || data.valor <= 0) {
                    showNotification('Descrição e valor válido são obrigatórios.', 'error');
                    return;
                }

                try {
                    const { error } = await db.from('servicos').update(data).eq('id', id);
                    if (error) throw error;
                    showNotification('Serviço atualizado!', 'success');
                    toggleServicoEditMode(id, true);
                } catch (err) {
                    console.error('Erro ao atualizar serviço:', err);
                    showNotification(`Erro ao atualizar: ${err.message}`, 'error');
                }
            };

            /** Initiates deletion of a service after confirmation. */
            const handleDeleteServico = (id) => showConfirmModal(
                'Excluir Serviço', 
                'Este serviço será removido de forma permanente. Confirma?', 
                async () => { 
                    try {
                        const { error } = await db.from('servicos').delete().eq('id', id); 
                        if (error) throw error;
                        showNotification('Serviço excluído com sucesso!', 'success'); 
                        triggerConfetti('success');
                    } catch (err) {
                        console.error('Erro ao excluir serviço:', err);
                        showNotification(`Erro ao excluir serviço: ${err.message}`, 'error'); 
                    }
                }
            );
            
            /** Resets the service form. */
            const resetServicoForm = () => { 
                state.editandoServicoId = null; 
                servicoForm.reset(); 
                $('#servico-form-title').innerHTML = 'Novo Serviço <i class="fas fa-clipboard-list" aria-hidden="true"></i>'; 
                $('#cancelar-edicao-servico').style.display = 'none'; 
                $$('#servico-form .validation-icon').forEach(icon => icon.className = 'validation-icon fas');
            };

            // ===================================================================================
            // NEW QUOTE (ORÇAMENTO) LOGIC
            // ===================================================================================
            
            /** Populates the client dropdown for new quotes. */
            const renderOrcamentoClienteOptions = () => { 
                if (state.clientes.length === 0) {
                    orcamentoClienteSelect.innerHTML = '<option value="">Nenhum cliente cadastrado</option>';
                    orcamentoClienteSelect.disabled = true;
                    return;
                }
                orcamentoClienteSelect.disabled = false;
                orcamentoClienteSelect.innerHTML = '<option value="">Selecione um cliente...</option>' + 
                    state.clientes.map(c => `<option value="${c.id}">${c.nome} ${c.carro ? `(${c.carro})` : ''}</option>`).join(''); 
            };
            
            /** Populates the service dropdown for new quotes. */
            const renderOrcamentoServicoOptions = () => { 
                if (state.servicos.length === 0) {
                    orcamentoServicoSelect.innerHTML = '<option value="">Nenhum serviço cadastrado</option>';
                    orcamentoServicoSelect.disabled = true;
                    addServicoBtn.disabled = true; 
                    orcamentoServicoQuantidadeInput.disabled = true;
                    return;
                }
                orcamentoServicoSelect.disabled = false;
                addServicoBtn.disabled = false;
                orcamentoServicoQuantidadeInput.disabled = false;
                orcamentoServicoSelect.innerHTML = '<option value="">Selecione um serviço...</option>' + 
                    state.servicos.map(s => `<option value="${s.id}">${s.descricao} (${formatCurrency(s.valor)})</option>`).join(''); 
            };
            
            /** Adds a selected service to the new quote's temporary item list. */
            const handleAddServicoToOrcamento = () => { 
                const id = orcamentoServicoSelect.value; 
                const quantidade = parseInt(orcamentoServicoQuantidadeInput.value, 10);
                if (!id || isNaN(quantidade) || quantidade <= 0) {
                    showNotification('Selecione um serviço e uma quantidade válida.', 'warning');
                    return;
                }
                const s = state.servicos.find(sv => sv.id == id); 
                if(!s) return;
                
                const existingItem = state.novoOrcamentoItens.find(item => item.servico_id === s.id);
                if (existingItem) {
                    existingItem.quantidade += quantidade;
                } else {
                    state.novoOrcamentoItens.push({ 
                        servico_id: s.id, 
                        descricao_servico: s.descricao, 
                        valor_cobrado: s.valor,
                        quantidade: quantidade
                    }); 
                }
                
                renderNovoOrcamentoItens(); 
                updateOrcamentoTotal(); 
                orcamentoServicoSelect.value = ''; 
                orcamentoServicoQuantidadeInput.value = '1';
            };
            
            /** Renders the list of services added to the current quote form. */
            const renderNovoOrcamentoItens = () => { 
                if (state.novoOrcamentoItens.length === 0) {
                    orcamentoServicosAdicionados.innerHTML = renderEmptyState('Nenhum serviço adicionado.', "Use o seletor acima para adicionar itens.");
                    return;
                }
                orcamentoServicosAdicionados.innerHTML = state.novoOrcamentoItens.map((item, index) => `
                    <li>
                        <div>
                            <strong>${item.descricao_servico}</strong><br>
                            <small>${formatCurrency(item.valor_cobrado)}</small>
                        </div>
                        <div class="item-actions">
                            <input type="number" min="1" value="${item.quantidade}" class="orcamento-item-quantity" data-index="${index}" title="Alterar Quantidade">
                            <button type="button" class="btn btn-sm btn-danger remove-servico-btn" data-index="${index}" title="Remover Serviço">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </li>
                `).join(''); 
            };
            
            /** Updates the total value of the new quote based on services and discount. */
            const updateOrcamentoTotal = () => { 
                const subtotal = state.novoOrcamentoItens.reduce((a, i) => a + (parseFloat(i.valor_cobrado) * i.quantidade), 0); 
                const discount = parseFloat(orcamentoDescontoInput.value) || 0; 
                const total = subtotal * (1 - discount / 100); 
                orcamentoTotalDiv.textContent = `TOTAL: ${formatCurrency(total)}`; 
            };
            
            /** Handles the submission of a new or edited quote. */
            const handleOrcamentoSubmit = async (e) => { 
                e.preventDefault(); 
                
                const clienteId = orcamentoClienteSelect.value;
                if (!clienteId) {
                    showNotification('Por favor, selecione um cliente.', 'warning');
                    return;
                }
                if (state.novoOrcamentoItens.length === 0) {
                    showNotification('Adicione ao menos um serviço ao orçamento.', 'warning');
                    return;
                }
                const selectedPaymentOptions = Array.from($$('.payment-option.active')).map(btn => btn.dataset.value);
                if (selectedPaymentOptions.length === 0) {
                    showNotification('Selecione ao menos uma forma de pagamento.', 'warning');
                    paymentOptionsValidation.style.display = 'block';
                    setTimeout(() => { paymentOptionsValidation.style.display = 'none'; }, 3000);
                    return;
                }

                const subtotal = state.novoOrcamentoItens.reduce((a, i) => a + (parseFloat(i.valor_cobrado) * i.quantidade), 0);
                const discount = parseFloat(orcamentoDescontoInput.value) || 0;
                const total = subtotal * (1 - discount / 100); 
                
                try {
                    let orcamentoData = { 
                        cliente_id: clienteId, 
                        desconto: discount, 
                        valor_total: total, 
                        formas_pagamento: selectedPaymentOptions.join(', '),
                        updated_at: new Date().toISOString()
                    };
                    
                    let orcamentoResult;
                    if (state.editandoOrcamentoId) { 
                        const { data, error } = await db.from('orcamentos').update(orcamentoData).eq('id', state.editandoOrcamentoId).select().single();
                        if (error) throw error;
                        orcamentoResult = data;
                        // Delete old items before inserting new ones
                        await db.from('orcamento_itens').delete().eq('orcamento_id', orcamentoResult.id);
                    } else { 
                        orcamentoData.status = 'Orçamento'; 
                        const { data, error } = await db.from('orcamentos').insert(orcamentoData).select().single();
                        if (error) throw error;
                        orcamentoResult = data;
                    }

                    const itemsToInsert = state.novoOrcamentoItens.map(i => ({ 
                        servico_id: i.servico_id, 
                        descricao_servico: i.descricao_servico, 
                        valor_cobrado: i.valor_cobrado,
                        quantidade: i.quantidade,
                        orcamento_id: orcamentoResult.id 
                    })); 
                    const { error: itemsError } = await db.from('orcamento_itens').insert(itemsToInsert); 
                    if (itemsError) throw itemsError;
                    
                    showNotification(`Orçamento ${state.editandoOrcamentoId ? 'atualizado' : 'salvo'} com sucesso!`, 'success'); 
                    triggerConfetti('success');
                    resetOrcamentoForm(); 
                    showTab('historico'); 
                } catch (err) {
                    console.error('Erro ao salvar/atualizar orçamento:', err);
                    showNotification(`Erro ao salvar orçamento: ${err.message}`, 'error'); 
                }
            };
            
            /** Resets the new quote form. */
            const resetOrcamentoForm = () => { 
                state.editandoOrcamentoId = null;
                orcamentoForm.reset(); 
                state.novoOrcamentoItens = []; 
                renderNovoOrcamentoItens(); 
                updateOrcamentoTotal(); 
                $$('.payment-option').forEach(b => b.classList.remove('active')); 
                orcamentoClienteSelect.value = ''; 
                paymentOptionsValidation.style.display = 'none';
                orcamentoFormTitle.innerHTML = 'Criar Novo Orçamento <i class="fas fa-file-invoice-dollar" aria-hidden="true"></i>';
                submitOrcamentoBtn.innerHTML = '<i class="fas fa-save" aria-hidden="true"></i> Salvar Orçamento';
                cancelarEdicaoOrcamentoBtn.style.display = 'none';
                orcamentoServicoQuantidadeInput.value = '1'; 
            };
            
            // ===================================================================================
            // HISTORY TAB LOGIC
            // ===================================================================================

            /** Renders the historical list of quotes based on filters. */
            const renderOrcamentos = () => {
                const searchTerm = searchHistoricoInput.value.toLowerCase().trim();
                const status = filterStatusSelect.value;
                const startDate = filterStartDateInput.value ? new Date(filterStartDateInput.value + 'T00:00:00') : null;
                const endDate = filterEndDateInput.value ? new Date(filterEndDateInput.value + 'T23:59:59') : null;

                const filtered = state.orcamentos.filter(o => {
                    const createdDate = new Date(o.created_at);
                    return (!searchTerm || (o.clientes?.nome.toLowerCase().includes(searchTerm) || o.clientes?.placa.toLowerCase().includes(searchTerm))) &&
                           (!status || o.status === status) &&
                           (!startDate || createdDate >= startDate) &&
                           (!endDate || createdDate <= endDate);
                });

                if (filtered.length === 0) {
                    historicoLista.innerHTML = renderEmptyState('Nenhum histórico encontrado.', 'Ajuste os filtros ou crie um novo orçamento.');
                    return;
                }
                historicoLista.innerHTML = filtered.map(o => `
                    <li data-id="${o.id}" class="data-list-item ${o.id === state.orcamentoSelecionado?.id ? 'selected' : ''}" tabindex="0">
                        <div>
                            <strong>${o.clientes?.nome || 'Cliente Removido'}</strong><br>
                            <small>${formatDateTime(o.created_at)}</small>
                        </div>
                        <div>
                            <span class="status-indicator status-${o.status}">${o.status}</span>
                            <strong>${formatCurrency(o.valor_total)}</strong>
                        </div>
                    </li>
                `).join('');
            };

            /** Displays the details of the selected quote. */
            const displayOrcamentoDetails = () => {
                if (!state.orcamentoSelecionado) { 
                    detalhesContainer.style.display = 'none'; 
                    return; 
                }
                const orc = state.orcamentoSelecionado;
                const { status } = orc;

                $('#detalhes-orcamento-texto').textContent = generateOrcamentoText(orc);
                
                $('#btn-edit-orcamento').style.display = status !== 'Cancelado' ? 'inline-flex' : 'none'; 
                $('#btn-aprovar').style.display = status === 'Orçamento' ? 'inline-flex' : 'none';
                $('#btn-finalizar').style.display = status === 'Aprovado' ? 'inline-flex' : 'none';
                $('#btn-cancelar').style.display = (status === 'Orçamento' || status === 'Aprovado') ? 'inline-flex' : 'none';
                
                const reciboBtn = $('#btn-view-recibo');
                if (status === 'Finalizado') {
                    $('#detalhes-recibo-texto').textContent = generateReciboText(orc);
                    reciboBtn.style.display = 'inline-flex';
                } else {
                    reciboBtn.style.display = 'none';
                    switchDetailView('orcamento');
                }
                detalhesContainer.style.display = 'block';
            };
            
            /** Initiates the edit process for a selected quote. */
            const handleEditOrcamento = () => {
                if (!state.orcamentoSelecionado) return;
                
                state.editandoOrcamentoId = state.orcamentoSelecionado.id;
                orcamentoIdToEditInput.value = state.orcamentoSelecionado.id; 
                
                orcamentoFormTitle.innerHTML = 'Editar Orçamento <i class="fas fa-edit" aria-hidden="true"></i>';
                orcamentoClienteSelect.value = state.orcamentoSelecionado.cliente_id;
                orcamentoDescontoInput.value = state.orcamentoSelecionado.desconto || 0;
                
                $$('.payment-option').forEach(btn => btn.classList.remove('active'));
                state.orcamentoSelecionado.formas_pagamento?.split(', ').forEach(fp => {
                    const btn = $(`.payment-option[data-value="${fp}"]`);
                    if (btn) btn.classList.add('active');
                });

                state.novoOrcamentoItens = [...state.orcamentoSelecionado.orcamento_itens];
                renderNovoOrcamentoItens();
                updateOrcamentoTotal();
                
                submitOrcamentoBtn.innerHTML = '<i class="fas fa-save" aria-hidden="true"></i> Atualizar Orçamento';
                cancelarEdicaoOrcamentoBtn.style.display = 'inline-flex';
                showTab('novo-orcamento'); 
                orcamentoFormTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
            };
            
            /** Updates the status of the selected quote. */
            const updateStatusOrcamento = async (newStatus) => { 
                if (!state.orcamentoSelecionado) return; 
                showConfirmModal(
                    `Alterar Status para "${newStatus}"?`, 
                    `Tem certeza que deseja mudar o status deste orçamento?`, 
                    async () => {
                        try {
                            const { error } = await db.from('orcamentos').update({ status: newStatus, updated_at: new Date().toISOString() }).eq('id', state.orcamentoSelecionado.id); 
                            if (error) throw error; 
                            
                            showNotification(`Orçamento ${newStatus.toLowerCase()}!`, 'success'); 
                            triggerConfetti(newStatus === 'Finalizado' ? 'success' : 'warning'); 
                        } catch (err) {
                            console.error('Erro ao atualizar status:', err);
                            showNotification(`Erro ao atualizar status: ${err.message}`, 'error'); 
                        }
                    }
                );
            };

            /** Handles deletion of the selected quote. */
            const handleDeleteOrcamento = () => showConfirmModal(
                'Excluir Orçamento', 
                'Esta ação é irreversível. O orçamento será permanentemente removido.', 
                async () => { 
                    try {
                        const { error } = await db.from('orcamentos').delete().eq('id', state.orcamentoSelecionado.id); 
                        if (error) throw error; 
                        
                        showNotification('Orçamento excluído!', 'success'); 
                        triggerConfetti('success');
                        state.orcamentoSelecionado = null; 
                        detalhesContainer.style.display = 'none'; 
                    } catch (err) {
                        console.error('Erro ao excluir orçamento:', err);
                        showNotification(`Erro ao excluir: ${err.message}`, 'error'); 
                    }
                }
            );
            
            // ===================================================================================
            // TEXT & PDF GENERATION
            // ===================================================================================

            const generateFooter = () => `\n==================================\n*${ESTABELECIMENTO.nome}*\n` +
                `CNPJ: ${ESTABELECIMENTO.cnpj}\n`+
                `📍 ${ESTABELECIMENTO.endereco}\n` +
                `*📞 Contato:* ${formatPhone(ESTABELECIMENTO.telefone)}\n\n` +
                `_${ESTABELECIMENTO.agradecimento}_`;

            const generateOrcamentoText = (orc) => { 
                const subtotal = orc.orcamento_itens.reduce((acc, item) => acc + (parseFloat(item.valor_cobrado) * item.quantidade), 0); 
                const servicosText = orc.orcamento_itens.map(item => `- ${item.descricao_servico} (x${item.quantidade}) - ${formatCurrency(parseFloat(item.valor_cobrado) * item.quantidade)}`).join('\n'); 
                
                return `*Orçamento - ${ESTABELECIMENTO.nome}*
==================================
*Data:* ${formatDateTime(orc.created_at)}
*Cliente:* ${orc.clientes?.nome || 'N/A'}
*Veículo:* ${orc.clientes?.carro || 'N/A'}
*Placa:* ${formatPlaca(orc.clientes?.placa)}

*SERVIÇOS:*\n${servicosText}

*Subtotal:* ${formatCurrency(subtotal)}
*Desconto:* ${orc.desconto || 0}%
*VALOR TOTAL:* ${formatCurrency(orc.valor_total)}

*Formas de Pagamento:* ${orc.formas_pagamento || 'N/A'}

==================================
*VALIDADE DESTE ORÇAMENTO: 7 DIAS*
==================================` + generateFooter();
            };
            
            const generateReciboText = (orc) => { 
                const servicosText = orc.orcamento_itens.map(item => `- ${item.descricao_servico} (x${item.quantidade})`).join('\n'); 
                
                return `*Recibo de Serviço (Não Fiscal)*
==================================
*Data da Finalização:* ${formatDateTime(orc.updated_at)}
*Cliente:* ${orc.clientes?.nome || 'N/A'}
*Veículo:* ${orc.clientes?.carro || 'N/A'}
*Placa:* ${formatPlaca(orc.clientes?.placa)}

*Serviço(s) Realizado(s):*\n${servicosText}

*Valor Pago:* ${formatCurrency(orc.valor_total)}
*Forma de Pagamento:* ${orc.formas_pagamento || 'N/A'}` + generateFooter(); 
            };
            
            const copyAndNotify = (text) => { 
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('Texto copiado!', 'success');
                }).catch(err => {
                    console.error('Failed to copy text:', err);
                    showNotification('Erro ao copiar texto.', 'error');
                });
            };
            
            const sendWhatsApp = (text) => { 
                if (!state.orcamentoSelecionado) return;
                const phone = cleanPhone(state.orcamentoSelecionado.clientes?.telefone); 
                const url = `https://api.whatsapp.com/send?${phone ? `phone=${phone}&` : ''}text=${encodeURIComponent(text)}`; 
                window.open(url, '_blank'); 
            };
            
            const generatePdf = (type) => {
                if (!state.orcamentoSelecionado) return;
                const orc = state.orcamentoSelecionado;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor('#ef4444'); 
                doc.text(ESTABELECIMENTO.nome, 14, 20);

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`CNPJ: ${ESTABELECIMENTO.cnpj}`, 14, 26);
                doc.text(ESTABELECIMENTO.endereco, 14, 31);
                doc.text(`Contato: ${formatPhone(ESTABELECIMENTO.telefone)}`, 14, 36);
                
                doc.setFontSize(16);
                doc.setTextColor(40);
                doc.text(type === 'orcamento' ? "ORÇAMENTO" : "RECIBO DE SERVIÇO", 14, 45);
                
                doc.autoTable({
                    startY: 50,
                    head: [['Cliente', 'Veículo', 'Placa', 'Data']],
                    body: [[
                        orc.clientes?.nome || 'N/A',
                        orc.clientes?.carro || 'N/A',
                        formatPlaca(orc.clientes?.placa),
                        formatDateTime(type === 'orcamento' ? orc.created_at : orc.updated_at)
                    ]],
                    theme: 'striped',
                    headStyles: { fillColor: [30, 41, 59] }
                });
                
                doc.autoTable({
                    startY: doc.autoTable.previous.finalY + 5,
                    head: [['Descrição do Serviço', 'Qtd.', 'Valor Unit.', 'Total']],
                    body: orc.orcamento_itens.map(item => [
                        item.descricao_servico,
                        item.quantidade,
                        formatCurrency(item.valor_cobrado),
                        formatCurrency(item.valor_cobrado * item.quantidade)
                    ]),
                    theme: 'grid',
                    headStyles: { fillColor: [30, 41, 59] },
                    footStyles: { fillColor: [30, 41, 59], textColor: [255, 255, 255], fontStyle: 'bold' },
                    foot: [
                        ['', '', 'Subtotal', formatCurrency(orc.orcamento_itens.reduce((acc, item) => acc + (item.valor_cobrado * item.quantidade), 0))],
                        ['', '', 'Desconto', `${orc.desconto || 0}%`],
                        ['', '', 'TOTAL', formatCurrency(orc.valor_total)]
                    ],
                    didDrawCell: (data) => {
                        if (data.section === 'foot' && data.column.index === 3) {
                            data.cell.styles.fontStyle = 'bold';
                            if (data.row.index === 2) {
                                data.cell.styles.textColor = [34, 197, 94]; // Green for total
                                data.cell.styles.fontSize = 12;
                            }
                        }
                    }
                });

                let finalY = doc.autoTable.previous.finalY;
                 if (type === 'orcamento') {
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor('#ef4444');
                    doc.text("Este orçamento é válido por 7 dias.", 14, finalY + 10);
                    finalY += 10;
                }

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(255, 255, 255);
                doc.text(`Formas de Pagamento: ${orc.formas_pagamento}`, 14, finalY + 10);
                doc.text(ESTABELECIMENTO.agradecimento, 14, finalY + 20);

                doc.save(`${type}_${orc.clientes?.nome.replace(/\s/g, '_') || 'cliente'}.pdf`);
                showNotification(`PDF de ${type} gerado!`, 'success');
            };

            // ===================================================================================
            // INITIALIZATION & EVENT LISTENERS
            // ===================================================================================
            
            const init = () => {
                const debouncedRenderClientes = debounce(renderClientes, 300);
                const debouncedRenderServicos = debounce(renderServicos, 300);
                const debouncedRenderOrcamentos = debounce(renderOrcamentos, 300);
                
                // --- Global Listeners ---
                syncBtn.addEventListener('click', () => fetchAllData(true)); 
                $$('.nav-btn').forEach(b => b.addEventListener('click', (e) => showTab(e.currentTarget.dataset.tab)));
                modalCancelBtn.addEventListener('click', hideConfirmModal);
                modalConfirmBtn.addEventListener('click', () => { 
                    if (typeof onConfirmCallback === 'function') onConfirmCallback(); 
                    hideConfirmModal(); 
                });
                
                // --- Dashboard Listeners ---
                $$('.dashboard-grid .stat-card').forEach(card => card.addEventListener('click', (e) => {
                    const { targetTab, filterValue } = e.currentTarget.dataset;
                    showTab(targetTab, { status: filterValue });
                }));
                recentActivityList.addEventListener('click', (e) => { 
                    const li = e.target.closest('li[data-id]'); 
                    if(li) { 
                        showTab('historico'); 
                        state.orcamentoSelecionado = state.orcamentos.find(o => o.id === li.dataset.id);
                        displayOrcamentoDetails();
                        $$('#historico-lista li').forEach(item => item.classList.remove('selected'));
                        $(`#historico-lista li[data-id="${li.dataset.id}"]`)?.classList.add('selected');
                    }
                });

                // --- Clients Listeners ---
                clienteForm.addEventListener('submit', handleClienteSubmit);
                clienteTelefoneInput.addEventListener('input', (e) => e.target.value = formatPhone(e.target.value));
                $('#cancelar-edicao-cliente').addEventListener('click', resetClienteForm);
                searchClienteInput.addEventListener('input', debouncedRenderClientes);
                sortClientesSelect.addEventListener('change', renderClientes);
                clientesLista.addEventListener('click', (e) => { 
                    const target = e.target;
                    const listItem = target.closest('li[data-id]');
                    if (!listItem) return;
                    const id = listItem.dataset.id;
                    
                    if (target.closest('.edit-cliente-btn')) toggleClienteEditMode(id);
                    else if (target.closest('.delete-cliente-btn')) handleDeleteCliente(id);
                    else if (target.closest('.save-inline-edit-btn')) handleSaveInlineEditCliente(id);
                    else if (target.closest('.cancel-inline-edit-btn')) toggleClienteEditMode(id, true);
                    else if (target.closest('.client-info-wrapper')) displayClientDetails(id);
                });
                clientesLista.addEventListener('input', (e) => {
                    const input = e.target;
                    if (input.matches('.inline-edit-input[data-field="telefone"]')) {
                        input.value = formatPhone(input.value);
                    }
                });
                closeClientDetailsBtn.addEventListener('click', () => clientDetailsPanel.style.display = 'none');
                $('#client-past-orcamentos').addEventListener('click', (e) => {
                    const li = e.target.closest('li[data-id]');
                    if (li) {
                        showTab('historico');
                        state.orcamentoSelecionado = state.orcamentos.find(o => o.id === li.dataset.id);
                        displayOrcamentoDetails();
                        $$('#historico-lista li').forEach(item => item.classList.remove('selected'));
                        $(`#historico-lista li[data-id="${li.dataset.id}"]`)?.classList.add('selected');
                    }
                });
                
                // --- Services Listeners ---
                servicoForm.addEventListener('submit', handleServicoSubmit);
                $('#cancelar-edicao-servico').addEventListener('click', resetServicoForm);
                searchServicoInput.addEventListener('input', debouncedRenderServicos);
                sortServicosSelect.addEventListener('change', renderServicos);
                servicosLista.addEventListener('click', (e) => {
                    const listItem = e.target.closest('li[data-id]');
                    if (!listItem) return;
                    const id = listItem.dataset.id;
                    if (e.target.closest('.edit-servico-btn')) toggleServicoEditMode(id);
                    else if (e.target.closest('.delete-servico-btn')) handleDeleteServico(id);
                    else if (e.target.closest('.save-inline-edit-btn')) handleSaveInlineEditServico(id);
                    else if (e.target.closest('.cancel-inline-edit-btn')) toggleServicoEditMode(id, true);
                });

                // --- Orcamento Form Listeners ---
                orcamentoForm.addEventListener('submit', handleOrcamentoSubmit);
                addServicoBtn.addEventListener('click', handleAddServicoToOrcamento);
                orcamentoServicosAdicionados.addEventListener('click', (e) => { 
                    if (e.target.closest('.remove-servico-btn')) {
                        state.novoOrcamentoItens.splice(e.target.closest('.remove-servico-btn').dataset.index, 1); 
                        renderNovoOrcamentoItens(); 
                        updateOrcamentoTotal();
                    } else if (e.target.matches('.orcamento-item-quantity')) {
                         e.target.addEventListener('change', (ev) => {
                            state.novoOrcamentoItens[ev.target.dataset.index].quantidade = parseInt(ev.target.value, 10);
                            updateOrcamentoTotal();
                         }, {once: true});
                    }
                });
                orcamentoDescontoInput.addEventListener('input', updateOrcamentoTotal);
                paymentOptionsContainer.addEventListener('click', (e) => { 
                    if (e.target.classList.contains('payment-option')) e.target.classList.toggle('active'); 
                });
                cancelarEdicaoOrcamentoBtn.addEventListener('click', resetOrcamentoForm);
                
                // --- History Listeners ---
                historicoLista.addEventListener('click', (e) => { 
                    const li = e.target.closest('li[data-id]'); 
                    if (!li) return;
                    $$('#historico-lista li').forEach(item => item.classList.remove('selected'));
                    li.classList.add('selected');
                    state.orcamentoSelecionado = state.orcamentos.find(o => o.id === li.dataset.id); 
                    displayOrcamentoDetails(); 
                    detalhesContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
                searchHistoricoInput.addEventListener('input', debouncedRenderOrcamentos);
                [filterStatusSelect, filterStartDateInput, filterEndDateInput].forEach(el => el.addEventListener('change', renderOrcamentos));
                clearFiltersBtn.addEventListener('click', () => {
                    searchHistoricoInput.value = '';
                    filterStatusSelect.value = '';
                    filterStartDateInput.value = '';
                    filterEndDateInput.value = '';
                    renderOrcamentos();
                });
                
                // --- Details Panel Listeners ---
                $('#btn-edit-orcamento').addEventListener('click', handleEditOrcamento);
                $('#btn-aprovar').addEventListener('click', () => updateStatusOrcamento('Aprovado'));
                $('#btn-finalizar').addEventListener('click', () => updateStatusOrcamento('Finalizado'));
                $('#btn-cancelar').addEventListener('click', () => updateStatusOrcamento('Cancelado'));
                $('#btn-excluir-orcamento').addEventListener('click', handleDeleteOrcamento);
                $('#btn-view-orcamento').addEventListener('click', () => switchDetailView('orcamento'));
                $('#btn-view-recibo').addEventListener('click', () => switchDetailView('recibo'));
                $('#btn-copiar-orcamento').addEventListener('click', () => copyAndNotify(generateOrcamentoText(state.orcamentoSelecionado)));
                $('#btn-whatsapp-orcamento').addEventListener('click', () => sendWhatsApp(generateOrcamentoText(state.orcamentoSelecionado)));
                $('#btn-copiar-recibo').addEventListener('click', () => copyAndNotify(generateReciboText(state.orcamentoSelecionado)));
                $('#btn-whatsapp-recibo').addEventListener('click', () => sendWhatsApp(generateReciboText(state.orcamentoSelecionado)));
                $('#btn-download-orcamento-pdf').addEventListener('click', () => generatePdf('orcamento'));
                $('#btn-download-recibo-pdf').addEventListener('click', () => generatePdf('recibo'));

                // --- Back to Top Button ---
                window.addEventListener('scroll', () => backToTopBtn.classList.toggle('show', window.scrollY > 400));
                backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

                // Initial load
                updateNetworkStatus();
                window.addEventListener('online', updateNetworkStatus);
                window.addEventListener('offline', updateNetworkStatus);
                setupSupabaseListeners(); 
                fetchAllData(true); 
            };

            // Run the app
            init();
        });
    </script>
</body>
</html>
