
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R.M. Est√©tica Automotiva - Gestor PRO+</title>
    
    <!-- Importa o cliente Supabase via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Estilos CSS -->
    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --bg-input: #2a2a2a;
            --text-light: #f5f5f5;
            --text-muted: #b0b0b0;
            --primary-red: #e53935;
            --primary-red-dark: #c62828;
            --green: #43a047;
            --green-dark: #2e7d32;
            --blue: #1e88e5;
            --orange: #fb8c00;
            --red-status: #d32f2f;
            --border-color: #383838;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { scroll-behavior: smooth; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container { max-width: 1200px; margin: 0 auto; padding: 15px; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-red);
            padding-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        header h1 { color: var(--primary-red); font-size: 1.5rem; font-weight: 600; }

        /* REFINED WRAPPING NAVIGATION */
        nav { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-bottom: 20px;
        }
        .nav-btn {
            padding: 10px 18px;
            background-color: var(--bg-card);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            font-size: 0.9rem;
            text-align: center;
            flex-grow: 1; /* Makes buttons take up space on smaller screens */
        }
        @media (min-width: 600px) {
            .nav-btn { flex-grow: 0; } /* Reverts on larger screens */
        }

        .nav-btn:hover { background-color: var(--bg-input); border-color: var(--text-muted); }
        .nav-btn.active { background-color: var(--primary-red); color: white; font-weight: bold; border-color: var(--primary-red); }
        
        .sync-btn {
            background: none; border: none; color: var(--text-muted); cursor: pointer;
            font-size: 1.8rem; transition: color 0.3s, transform 0.3s;
        }
        .sync-btn.syncing { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .grid-layout, .historico-layout, .dashboard-main-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 20px; 
        }
        @media (min-width: 768px) { 
            .grid-layout { grid-template-columns: 1fr 1.5fr; } 
            .dashboard-main-grid { grid-template-columns: 1.5fr 1fr; }
        }
        @media (min-width: 992px) {
            .historico-layout { grid-template-columns: 1fr 1.5fr; }
        }

        .card { 
            background-color: var(--bg-card); 
            padding: 25px; 
            border-radius: 12px; 
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        .card h2 {
            margin-top: 0; margin-bottom: 20px; color: var(--primary-red);
            border-bottom: 1px solid var(--border-color); padding-bottom: 10px; font-size: 1.2rem;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; font-weight: 500;}
        
        .search-container { position: relative; margin-bottom: 20px; }
        .search-container input { padding-left: 40px; }
        .search-container::before { content: 'üîé'; position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        input, select {
            width: 100%; padding: 14px; background-color: var(--bg-input);
            border: 1px solid var(--border-color); border-radius: 8px;
            color: var(--text-light); font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(229, 57, 53, 0.2);
        }

        .btn {
            display: inline-block; padding: 14px 22px; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; text-transform: uppercase;
            font-size: 0.9rem; transition: background-color 0.3s, transform 0.1s;
            width: 100%; text-align: center; margin-top: 5px;
        }
        @media(min-width: 992px) { .btn { width: auto; } }
        
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-red); color: white; }
        .btn-primary:hover { background-color: var(--primary-red-dark); }
        .btn-secondary { background-color: #4f4f4f; color: white; }
        .btn-secondary:hover { background-color: #616161; }
        .btn-danger { background-color: var(--red-status); color: white; }
        .btn-success { background-color: var(--green); color: white; }
        .btn-success:hover { background-color: var(--green-dark); }
        .btn-sm { padding: 10px 14px; font-size: 0.8rem; width: auto; }

        .data-list ul { list-style: none; padding: 0; max-height: 550px; overflow-y: auto; }
        /* BETTER EMPTY STATE */
        .empty-list-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            background-color: var(--bg-input);
            border-radius: 8px;
            border: 2px dashed var(--border-color);
        }
        .empty-list-message p { font-size: 1.1rem; margin-bottom: 10px; }
        
        .data-list li {
            display: flex; justify-content: space-between; align-items: center; padding: 15px;
            background-color: var(--bg-input);
            border-radius: 8px; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;
            border-left: 4px solid var(--border-color);
            transition: border-left-color 0.3s;
        }
        .data-list li:hover { border-left-color: var(--primary-red); }

        .data-list li > div:first-child { flex-grow: 1; }
        .item-actions { display: flex; gap: 10px; flex-shrink: 0; align-items: center; }
        
        #orcamento-total { margin-top: 20px; font-size: 1.6rem; font-weight: bold; color: var(--primary-red); text-align: center; }
        
        .payment-options-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .payment-option {
            padding: 12px 15px; background-color: var(--bg-input); border: 1px solid var(--border-color);
            border-radius: 8px; cursor: pointer; transition: all 0.2s;
            font-size: 0.9rem; color: var(--text-muted); text-align: center;
        }
        .payment-option.active {
            background-color: var(--blue); color: white; border-color: var(--blue); font-weight: bold;
        }
        
        #historico-lista li, #recent-activity-list li { cursor: pointer; transition: background-color 0.2s, border-left-color 0.2s; }
        #historico-lista li.selected, #recent-activity-list li.selected { background-color: var(--bg-input); border-left-color: var(--primary-red); }
        
        .status-indicator { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; color: white; font-weight: 500; margin-right: 10px; }
        .status-Or√ßamento { background-color: var(--blue); }
        .status-Aprovado { background-color: var(--orange); }
        .status-Finalizado { background-color: var(--green); }
        .status-Cancelado { background-color: var(--red-status); }

        .detalhe-view-switcher { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;}
        .detalhe-view-btn { padding: 8px 15px; background-color: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; flex-grow: 1; text-align: center;}
        .detalhe-view-btn.active { background-color: var(--primary-red); color: white; font-weight: bold; border-color: var(--primary-red); }

        .detalhe-bloco {
            background-color: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 15px; margin-top: 10px;
        }
        .detalhe-bloco h3 { margin-top: 0; margin-bottom: 10px; color: var(--text-muted); font-size: 1rem; font-weight: 500; }
        .detalhe-bloco pre {
            white-space: pre-wrap; word-wrap: break-word; color: var(--text-light);
            font-family: 'Courier New', Courier, monospace; font-size: 0.95rem;
            background-color: var(--bg-input); padding: 15px; border-radius: 8px;
        }
        .detalhe-bloco-actions { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
        .detalhes-status-actions { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 10px; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .stat-card { background-color: var(--bg-card); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid var(--border-color); }
        .stat-card .icon { font-size: 2.2rem; margin-bottom: 10px; }
        .stat-card h3 { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase; font-weight: 500;}
        .stat-card p { font-size: 2rem; font-weight: bold; color: var(--primary-red); }

        /* Notification & Modals */
        #notification {
            position: fixed; bottom: 20px; left: 50%; transform: translate(-50%, 150%);
            padding: 15px 20px; border-radius: 8px; color: white; z-index: 1000;
            text-align: center; visibility: hidden; transition: transform 0.5s, visibility 0.5s;
            max-width: 90%; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        #notification.show { transform: translate(-50%, 0); visibility: visible; }
        #notification.success { background-color: var(--green); }
        #notification.error { background-color: var(--red-status); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); display: none; justify-content: center;
            align-items: center; z-index: 2000; padding: 15px;
        }
        .modal-content {
            background-color: var(--bg-card); padding: 30px; border-radius: 12px;
            text-align: center; max-width: 400px; width: 100%;
            border: 1px solid var(--border-color); box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .modal-content h3 { margin-bottom: 15px; color: var(--primary-red); }
        .modal-content p { margin-bottom: 25px; }
        .modal-actions { display: flex; justify-content: center; gap: 15px; }
        
        /* NEW: Sync Overlay */
        #sync-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85); display: none; justify-content: center;
            align-items: center; z-index: 3000; color: white; text-align: center;
            font-size: 1.2rem; flex-direction: column; gap: 20px;
        }
        
        /* NEW: Back to Top Button */
        #back-to-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--primary-red);
            color: white;
            border: none;
            border-radius: 50%;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #back-to-top-btn.show {
            display: flex;
            opacity: 0.8;
        }
        #back-to-top-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h1>üöó R.M. Est√©tica PRO+</h1>
            <button class="sync-btn" id="sync-btn" title="Sincronizar Dados">üîÑ</button>
        </header>

        <nav>
            <button class="nav-btn active" data-tab="dashboard">Painel üìä</button>
            <button class="nav-btn" data-tab="clientes">Clientes üë•</button>
            <button class="nav-btn" data-tab="servicos">Servi√ßos üõ†Ô∏è</button>
            <button class="nav-btn" data-tab="novo-orcamento">Or√ßamento üìù</button>
            <button class="nav-btn" data-tab="historico">Hist√≥rico üìÇ</button>
        </nav>

        <main>
            <section id="dashboard-tab" class="tab-content active">
                <div class="dashboard-main-grid">
                    <div class="card">
                        <h2>Vis√£o Geral</h2>
                        <div class="dashboard-grid">
                            <div class="stat-card"><div class="icon">üë•</div><h3>Clientes</h3><p id="stat-clientes">0</p></div>
                            <div class="stat-card"><div class="icon">üìù</div><h3>Pendentes</h3><p id="stat-pendentes">0</p></div>
                            <div class="stat-card"><div class="icon">üëç</div><h3>Aprovados</h3><p id="stat-aprovados">0</p></div>
                            <div class="stat-card"><div class="icon">‚úÖ</div><h3>M√™s Atual</h3><p id="stat-finalizados-mes">0</p></div>
                        </div>
                    </div>
                    <div class="card data-list">
                        <h2>Atividade Recente ‚ö°</h2>
                        <ul id="recent-activity-list"></ul>
                    </div>
                </div>
            </section>
            
            <section id="clientes-tab" class="tab-content">
                 <div class="grid-layout">
                    <div class="card">
                        <h2 id="cliente-form-title">Novo Cliente üßë‚Äçü§ù‚Äçüßë</h2>
                        <form id="cliente-form">
                            <input type="hidden" id="cliente-id">
                            <div class="form-group"><label for="cliente-nome">Nome Completo</label><input type="text" id="cliente-nome" required></div>
                            <div class="form-group"><label for="cliente-telefone">Telefone (WhatsApp)</label><input type="tel" id="cliente-telefone" placeholder="(24) 99999-8888"></div>
                            <div class="form-group"><label for="cliente-carro">Ve√≠culo</label><input type="text" id="cliente-carro"></div>
                            <div class="form-group"><label for="cliente-placa">Placa</label><input type="text" id="cliente-placa"></div>
                            <button type="submit" class="btn btn-primary">Salvar üíæ</button>
                            <button type="button" id="cancelar-edicao-cliente" class="btn btn-secondary" style="display: none;">Cancelar</button>
                        </form>
                    </div>
                    <div class="card data-list">
                        <h2>Clientes Cadastrados</h2>
                        <div class="search-container"><input type="search" id="search-cliente" placeholder="Buscar cliente por nome ou placa..."></div>
                        <ul id="clientes-lista"></ul>
                    </div>
                </div>
            </section>
            
            <section id="servicos-tab" class="tab-content">
                 <div class="grid-layout">
                    <div class="card">
                        <h2 id="servico-form-title">Novo Servi√ßo üìã</h2>
                        <form id="servico-form">
                            <input type="hidden" id="servico-id">
                            <div class="form-group"><label for="servico-descricao">Descri√ß√£o</label><input type="text" id="servico-descricao" required></div>
                            <div class="form-group"><label for="servico-valor">Valor (R$)</label><input type="number" id="servico-valor" step="0.01" required></div>
                            <button type="submit" class="btn btn-primary">Salvar üíæ</button>
                            <button type="button" id="cancelar-edicao-servico" class="btn btn-secondary" style="display: none;">Cancelar</button>
                        </form>
                    </div>
                     <div class="card data-list">
                        <h2>Servi√ßos Cadastrados</h2>
                        <div class="search-container"><input type="search" id="search-servico" placeholder="Buscar servi√ßo..."></div>
                        <ul id="servicos-lista"></ul>
                    </div>
                </div>
            </section>

            <section id="novo-orcamento-tab" class="tab-content">
                <div class="card">
                    <h2>Criar Novo Or√ßamento ‚úçÔ∏è</h2>
                    <form id="orcamento-form">
                        <div class="form-group"><label for="orcamento-cliente">Cliente</label><select id="orcamento-cliente" required></select></div>
                        <div class="form-group"><label for="orcamento-servico-select">Adicionar Servi√ßo</label><div style="display: flex; gap: 10px;"><select id="orcamento-servico-select" style="flex-grow: 1;"></select><button type="button" id="add-servico-btn" class="btn btn-primary btn-sm" style="width: 50px;">+</button></div></div>
                        <h3>Servi√ßos Adicionados</h3><div class="data-list"><ul id="orcamento-servicos-adicionados" style="min-height: 50px;"></ul></div>
                        <div class="form-group" style="margin-top: 20px;"><label for="orcamento-desconto">Desconto (%)</label><input type="number" id="orcamento-desconto" value="0" min="0" max="100"></div>
                        <div class="form-group"><label>Formas de Pagamento</label><div class="payment-options-group" id="payment-options"><button type="button" class="payment-option" data-value="Pix">Pix</button><button type="button" class="payment-option" data-value="Dinheiro">Dinheiro</button><button type="button" class="payment-option" data-value="Cr√©dito">Cr√©dito</button><button type="button" class="payment-option" data-value="D√©bito">D√©bito</button></div></div>
                        <div id="orcamento-total">TOTAL: R$ 0,00</div>
                        <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Salvar Or√ßamento üíæ</button>
                    </form>
                </div>
            </section>

            <section id="historico-tab" class="tab-content">
                <div class="historico-layout">
                    <div class="card data-list">
                        <h2>Hist√≥rico de Servi√ßos</h2>
                        <div class="search-container"><input type="search" id="search-historico" placeholder="Buscar por cliente..."></div>
                        <ul id="historico-lista"></ul>
                    </div>
                    <div class="card" id="detalhes-orcamento-container" style="display: none;">
                        <h2>Detalhes do Servi√ßo üîé</h2>
                        
                        <div class="detalhe-view-switcher">
                            <button id="btn-view-orcamento" class="detalhe-view-btn active">Or√ßamento</button>
                            <button id="btn-view-recibo" class="detalhe-view-btn" style="display: none;">Recibo</button>
                        </div>
                        
                        <div id="detalhe-orcamento-bloco" class="detalhe-bloco">
                           <h3>Texto do Or√ßamento</h3>
                           <pre id="detalhes-orcamento-texto"></pre>
                           <div class="detalhe-bloco-actions">
                               <button id="btn-copiar-orcamento" class="btn btn-sm btn-secondary">Copiar üìã</button>
                               <button id="btn-whatsapp-orcamento" class="btn btn-sm btn-success">WhatsApp üí¨</button>
                           </div>
                        </div>

                        <div id="detalhe-recibo-bloco" class="detalhe-bloco" style="display: none;">
                            <h3>Texto do Recibo de Servi√ßo</h3>
                            <pre id="detalhes-recibo-texto"></pre>
                            <div class="detalhe-bloco-actions">
                                <button id="btn-copiar-recibo" class="btn btn-sm btn-secondary">Copiar üìã</button>
                                <button id="btn-whatsapp-recibo" class="btn btn-sm btn-success">WhatsApp üí¨</button>
                            </div>
                        </div>

                        <div class="detalhes-status-actions">
                             <button id="btn-aprovar" class="btn btn-sm" style="background-color: var(--orange)">Aprovar üëç</button>
                             <button id="btn-finalizar" class="btn btn-sm" style="background-color: var(--green)">Finalizar ‚úÖ</button>
                             <button id="btn-cancelar" class="btn btn-sm" style="background-color: var(--red-status);">Cancelar üëé</button>
                             <button id="btn-excluir-orcamento" class="btn btn-sm btn-danger">Excluir üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <div id="notification"></div>
    
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">Confirmar A√ß√£o</h3>
            <p id="modal-message">Voc√™ tem certeza?</p>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="btn btn-secondary">Cancelar</button>
                <button id="modal-confirm-btn" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="sync-overlay">
        <div class="sync-btn syncing" style="font-size: 3rem;">üîÑ</div>
        <p>Sincronizando dados...</p>
    </div>

    <button id="back-to-top-btn" title="Voltar ao topo">‚Üë</button>

    <script type="module">
        // ===================================================================================
        // DADOS DO ESTABELECIMENTO
        // ===================================================================================
        const ESTABELECIMENTO = {
            nome: "R.M. Est√©tica Automotiva",
            telefone: "24999486232", // Somente n√∫meros para o link do WhatsApp
            endereco: "Rua 40, TV - Recanto dos P√°ssaros, Pq. Mambucaba, Angra dos Reis - RJ",
            agradecimento: "Obrigado pela prefer√™ncia e volte sempre! üëç"
        };

        // ===================================================================================
        // CONFIGURA√á√ÉO DO SUPABASE
        // ===================================================================================
        const SUPABASE_URL = 'https://uymunsavnpfcsuznrugi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5bXVuc2F2bnBmY3N1em5ydWdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3ODU3ODgsImV4cCI6MjA2NjM2MTc4OH0.Kz__-jB9SsD-w7SuwlYCWPuEOcOX9epRE9CB5jd4eFY';
        
        if (!SUPABASE_URL || !SUPABASE_KEY) {
            document.body.innerHTML = `<div style="padding: 40px; text-align: center; font-size: 1.2rem; color: #ffcc00; background-color: #333; height: 100vh;"><h1>Erro de Configura√ß√£o</h1><p>As credenciais do Supabase n√£o foram encontradas.</p></div>`;
            throw new Error("Credenciais do Supabase n√£o configuradas.");
        }

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ===================================================================================
        // IN√çCIO DA L√ìGICA DA APLICA√á√ÉO
        // ===================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            let state = {
                clientes: [], servicos: [], orcamentos: [],
                editandoClienteId: null, editandoServicoId: null,
                novoOrcamentoItens: [], orcamentoSelecionado: null,
                isSyncing: false
            };

            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);

            const syncBtn = $('#sync-btn'), notification = $('#notification'), syncOverlay = $('#sync-overlay'), backToTopBtn = $('#back-to-top-btn');
            const clienteForm = $('#cliente-form'), clientesLista = $('#clientes-lista'), searchClienteInput = $('#search-cliente'), clienteTelefoneInput = $('#cliente-telefone');
            const servicoForm = $('#servico-form'), servicosLista = $('#servicos-lista'), searchServicoInput = $('#search-servico');
            const orcamentoForm = $('#orcamento-form'), orcamentoClienteSelect = $('#orcamento-cliente'), orcamentoServicoSelect = $('#orcamento-servico-select'), addServicoBtn = $('#add-servico-btn'), orcamentoServicosAdicionados = $('#orcamento-servicos-adicionados'), orcamentoDescontoInput = $('#orcamento-desconto'), orcamentoTotalDiv = $('#orcamento-total'), paymentOptionsContainer = $('#payment-options');
            const historicoLista = $('#historico-lista'), searchHistoricoInput = $('#search-historico'), detalhesContainer = $('#detalhes-orcamento-container'), recentActivityList = $('#recent-activity-list');
            const confirmModal = $('#confirm-modal'), modalConfirmBtn = $('#modal-confirm-btn'), modalCancelBtn = $('#modal-cancel-btn');
            let onConfirmCallback = null;

            const showNotification = (message, type = 'success') => { notification.textContent = message; notification.className = `show ${type}`; setTimeout(() => notification.className = notification.className.replace('show', ''), 3000); };
            const showTab = (tabId) => { $$('.tab-content').forEach(t => t.classList.remove('active')); $$('.nav-btn').forEach(b => b.classList.remove('active')); $(`#${tabId}-tab`).classList.add('active'); $(`.nav-btn[data-tab="${tabId}"]`).classList.add('active'); };
            const formatCurrency = (v) => v != null ? parseFloat(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
            const formatDateTime = (d) => d ? new Date(d).toLocaleString('pt-BR', {timeZone: 'America/Sao_Paulo'}) : 'N/A';
            const showConfirmModal = (title, message, callback) => { $('#modal-title').textContent = title; $('#modal-message').textContent = message; onConfirmCallback = callback; confirmModal.style.display = 'flex'; };
            const hideConfirmModal = () => { confirmModal.style.display = 'none'; onConfirmCallback = null; };
            const formatPhone = (value) => { if (!value) return ""; value = value.replace(/\D/g, '').slice(0, 11); if (value.length > 6) value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3'); else if (value.length > 2) value = value.replace(/(\d{2})(\d+)/, '($1) $2'); return value; };
            const cleanPhone = (value) => value ? `55${value.replace(/\D/g, '')}` : null;
            const createEmptyListMessage = (message, suggestion) => `<div class="empty-list-message"><p>${message}</p><small>${suggestion}</small></div>`;

            const fetchAllData = async () => {
                if (state.isSyncing) return;
                state.isSyncing = true;
                syncBtn.classList.add('syncing');
                syncOverlay.style.display = 'flex';
                try {
                    const [clientesRes, servicosRes, orcamentosRes] = await Promise.all([
                        db.from('clientes').select('*').order('nome', { ascending: true }),
                        db.from('servicos').select('*').order('descricao', { ascending: true }),
                        db.from('orcamentos').select(`id, created_at, updated_at, valor_total, status, clientes ( nome, carro )`).order('created_at', { ascending: false })
                    ]);
                    if (clientesRes.error) throw new Error(`Clientes: ${clientesRes.error.message}`);
                    if (servicosRes.error) throw new Error(`Servi√ßos: ${servicosRes.error.message}`);
                    if (orcamentosRes.error) throw new Error(`Or√ßamentos: ${orcamentosRes.error.message}`);
                    
                    state.clientes = clientesRes.data;
                    state.servicos = servicosRes.data;
                    state.orcamentos = orcamentosRes.data;
                    renderAll();
                    showNotification('Dados sincronizados!', 'success');
                } catch (error) {
                    showNotification(`Falha ao sincronizar: ${error.message}`, 'error');
                } finally {
                    state.isSyncing = false;
                    syncBtn.classList.remove('syncing');
                    syncOverlay.style.display = 'none';
                }
            };
            const renderAll = () => { renderClientes(); renderServicos(); renderOrcamentos(); renderOrcamentoClienteOptions(); renderOrcamentoServicoOptions(); updateDashboard(); renderRecentActivity(); };

            const updateDashboard = () => {
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                $('#stat-clientes').textContent = state.clientes.length;
                $('#stat-pendentes').textContent = state.orcamentos.filter(o => o.status === 'Or√ßamento').length;
                $('#stat-aprovados').textContent = state.orcamentos.filter(o => o.status === 'Aprovado').length;
                $('#stat-finalizados-mes').textContent = state.orcamentos.filter(o => o.status === 'Finalizado' && new Date(o.updated_at) >= startOfMonth).length;
            };

            const renderRecentActivity = () => {
                const recentOrcamentos = state.orcamentos.slice(0, 8);
                if (recentOrcamentos.length === 0) {
                    recentActivityList.innerHTML = createEmptyListMessage('Nenhuma atividade recente.', 'Crie um novo or√ßamento para come√ßar.');
                    return;
                }
                recentActivityList.innerHTML = recentOrcamentos.map(orc => {
                    const cliente = orc.clientes;
                    if (!cliente) return ''; 
                    const dataSimples = new Date(orc.created_at).toLocaleDateString('pt-BR');
                    return `
                        <li data-id="${orc.id}">
                            <div>
                                <strong>${cliente.nome}</strong><br>
                                <small style="color: var(--text-muted);">üöó ${cliente.carro || 'Ve√≠culo n√£o informado'}</small>
                            </div>
                            <div>
                                <span class="status-indicator status-${orc.status}">${orc.status}</span>
                                <small>${dataSimples}</small>
                            </div>
                        </li>
                    `;
                }).join('');
            };

            const renderClientes = () => {
                const searchTerm = searchClienteInput.value.toLowerCase();
                const filtered = state.clientes.filter(c => c.nome.toLowerCase().includes(searchTerm) || (c.placa && c.placa.toLowerCase().includes(searchTerm)));
                if (filtered.length === 0) {
                    clientesLista.innerHTML = createEmptyListMessage('Nenhum cliente encontrado.', 'Adicione um novo cliente no formul√°rio.');
                    return;
                }
                clientesLista.innerHTML = filtered.map(c => `<li><div><strong>${c.nome}</strong><br><small>üöó ${c.carro || 'N/D'} | Placa: ${c.placa || 'N/D'}</small></div><div class="item-actions"><button class="btn btn-sm btn-secondary edit-cliente-btn" data-id="${c.id}">Editar</button><button class="btn btn-sm btn-danger delete-cliente-btn" data-id="${c.id}">üóëÔ∏è</button></div></li>`).join('');
            };
            const handleClienteSubmit = async (e) => { e.preventDefault(); const data = { nome: $('#cliente-nome').value.trim(), telefone: $('#cliente-telefone').value.trim(), carro: $('#cliente-carro').value.trim(), placa: $('#cliente-placa').value.trim() }; const { error } = state.editandoClienteId ? await db.from('clientes').update(data).eq('id', state.editandoClienteId) : await db.from('clientes').insert(data); if (error) return showNotification(`Erro ao salvar cliente: ${error.message}`, 'error'); showNotification(`Cliente ${state.editandoClienteId ? 'atualizado' : 'cadastrado'}!`); resetClienteForm(); fetchAllData(); };
            const handleEditCliente = (id) => { const c = state.clientes.find(cl => cl.id == id); if(!c) return; state.editandoClienteId = id; $('#cliente-form-title').textContent = 'Editar Cliente'; $('#cliente-nome').value = c.nome; $('#cliente-telefone').value = c.telefone; $('#cliente-carro').value = c.carro; $('#cliente-placa').value = c.placa; $('#cancelar-edicao-cliente').style.display = 'block'; $('#cliente-form-title').scrollIntoView(); };
            const handleDeleteCliente = (id) => showConfirmModal('Excluir Cliente', 'Esta a√ß√£o √© irrevers√≠vel e ir√° apagar tamb√©m todos os or√ßamentos deste cliente. Deseja continuar?', async () => { const { error } = await db.from('clientes').delete().eq('id', id); if (error) showNotification(`Erro ao excluir cliente: ${error.message}`, 'error'); else { showNotification('Cliente exclu√≠do.'); fetchAllData(); } hideConfirmModal(); });
            const resetClienteForm = () => { state.editandoClienteId = null; clienteForm.reset(); $('#cliente-form-title').textContent = 'Novo Cliente üßë‚Äçü§ù‚Äçüßë'; $('#cancelar-edicao-cliente').style.display = 'none'; };
            
            const renderServicos = () => {
                const searchTerm = searchServicoInput.value.toLowerCase();
                const filtered = state.servicos.filter(s => s.descricao.toLowerCase().includes(searchTerm));
                 if (filtered.length === 0) {
                    servicosLista.innerHTML = createEmptyListMessage('Nenhum servi√ßo encontrado.', 'Adicione um novo servi√ßo no formul√°rio.');
                    return;
                }
                servicosLista.innerHTML = filtered.map(s => `<li><div><strong>${s.descricao}</strong><br><small>${formatCurrency(s.valor)}</small></div><div class="item-actions"><button class="btn btn-sm btn-secondary edit-servico-btn" data-id="${s.id}">Editar</button><button class="btn btn-sm btn-danger delete-servico-btn" data-id="${s.id}">üóëÔ∏è</button></div></li>`).join('');
            };
            const handleServicoSubmit = async (e) => { e.preventDefault(); const data = { descricao: $('#servico-descricao').value.trim(), valor: $('#servico-valor').value }; const { error } = state.editandoServicoId ? await db.from('servicos').update(data).eq('id', state.editandoServicoId) : await db.from('servicos').insert(data); if (error) return showNotification(`Erro ao salvar servi√ßo: ${error.message}`, 'error'); showNotification(`Servi√ßo ${state.editandoServicoId ? 'atualizado' : 'cadastrado'}!`); resetServicoForm(); fetchAllData(); };
            const handleEditServico = (id) => { const s = state.servicos.find(sv => sv.id == id); if (!s) return; state.editandoServicoId = id; $('#servico-form-title').textContent = 'Editar Servi√ßo'; $('#servico-descricao').value = s.descricao; $('#servico-valor').value = s.valor; $('#cancelar-edicao-servico').style.display = 'block'; $('#servico-form-title').scrollIntoView(); };
            const handleDeleteServico = (id) => showConfirmModal('Excluir Servi√ßo', 'Este servi√ßo ser√° removido. Confirma?', async () => { const { error } = await db.from('servicos').delete().eq('id', id); if (error) showNotification('Erro ao excluir servi√ßo.', 'error'); else { showNotification('Servi√ßo exclu√≠do.'); fetchAllData(); } hideConfirmModal(); });
            const resetServicoForm = () => { state.editandoServicoId = null; servicoForm.reset(); $('#servico-form-title').textContent = 'Novo Servi√ßo üìã'; $('#cancelar-edicao-servico').style.display = 'none'; };

            const renderOrcamentoClienteOptions = () => { orcamentoClienteSelect.innerHTML = '<option value="">Selecione...</option>' + state.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join(''); };
            const renderOrcamentoServicoOptions = () => { orcamentoServicoSelect.innerHTML = '<option value="">Selecione...</option>' + state.servicos.map(s => `<option value="${s.id}">${s.descricao} (${formatCurrency(s.valor)})</option>`).join(''); };
            const handleAddServicoToOrcamento = () => { const id = orcamentoServicoSelect.value; if (!id) return; const s = state.servicos.find(sv => sv.id == id); if(!s) return; if(state.novoOrcamentoItens.some(i => i.servico_id == s.id)) return showNotification('Servi√ßo j√° adicionado.', 'error'); state.novoOrcamentoItens.push({ servico_id: s.id, descricao_servico: s.descricao, valor_cobrado: s.valor }); renderNovoOrcamentoItens(); updateOrcamentoTotal(); orcamentoServicoSelect.value = ''; };
            const renderNovoOrcamentoItens = () => { orcamentoServicosAdicionados.innerHTML = state.novoOrcamentoItens.map((item, index) => `<li><div>${item.descricao_servico} - ${formatCurrency(item.valor_cobrado)}</div><button type="button" class="btn btn-sm btn-danger remove-servico-btn" data-index="${index}">x</button></li>`).join(''); };
            const handleRemoveServicoFromOrcamento = (index) => { state.novoOrcamentoItens.splice(index, 1); renderNovoOrcamentoItens(); updateOrcamentoTotal(); };
            const updateOrcamentoTotal = () => { const sub = state.novoOrcamentoItens.reduce((a, i) => a + parseFloat(i.valor_cobrado), 0); const desc = parseFloat(orcamentoDescontoInput.value) || 0; orcamentoTotalDiv.textContent = `TOTAL: ${formatCurrency(sub * (1 - desc / 100))}`; };
            const handleOrcamentoSubmit = async (e) => { e.preventDefault(); if (state.novoOrcamentoItens.length === 0 || !orcamentoClienteSelect.value) return showNotification('Cliente e ao menos um servi√ßo s√£o obrigat√≥rios.', 'error'); const sub = state.novoOrcamentoItens.reduce((a, i) => a + parseFloat(i.valor_cobrado), 0); const desc = parseFloat(orcamentoDescontoInput.value) || 0; const total = sub * (1 - desc / 100); const fpg = Array.from($$('.payment-option.active')).map(btn => btn.dataset.value).join(', '); const { data, error } = await db.from('orcamentos').insert({ cliente_id: orcamentoClienteSelect.value, desconto: desc, valor_total: total, status: 'Or√ßamento', formas_pagamento: fpg }).select().single(); if (error) return showNotification(`Erro ao salvar or√ßamento: ${error.message}`, 'error'); const itens = state.novoOrcamentoItens.map(i => ({ ...i, orcamento_id: data.id })); const { error: iError } = await db.from('orcamento_itens').insert(itens); if (iError) { showNotification(`Erro ao salvar itens: ${iError.message}`, 'error'); await db.from('orcamentos').delete().eq('id', data.id); return; } showNotification('Or√ßamento salvo com sucesso!'); resetOrcamentoForm(); fetchAllData(); showTab('historico'); };
            const resetOrcamentoForm = () => { orcamentoForm.reset(); state.novoOrcamentoItens = []; renderNovoOrcamentoItens(); updateOrcamentoTotal(); $$('.payment-option').forEach(b => b.classList.remove('active')); };
            
            const renderOrcamentos = () => {
                const searchTerm = searchHistoricoInput.value.toLowerCase();
                const filtered = state.orcamentos.filter(o => o.clientes?.nome && o.clientes.nome.toLowerCase().includes(searchTerm));
                if (filtered.length === 0) {
                    historicoLista.innerHTML = createEmptyListMessage('Nenhum hist√≥rico encontrado.', 'Filtre por outro nome ou crie um novo or√ßamento.');
                    return;
                }
                historicoLista.innerHTML = filtered.map(o => `<li data-id="${o.id}"><div><strong>${o.clientes?.nome || 'Cliente Removido'}</strong><br><small>${formatDateTime(o.created_at)}</small></div><div><span class="status-indicator status-${o.status}">${o.status}</span><strong>${formatCurrency(o.valor_total)}</strong></div></li>`).join('');
            };
            const handleHistoricoClick = async (id) => { $$('#historico-lista li').forEach(li => li.classList.remove('selected')); const selectedLi = $(`#historico-lista li[data-id="${id}"]`); if (selectedLi) { selectedLi.classList.add('selected'); selectedLi.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } const { data, error } = await db.from('orcamentos').select(`*, clientes (*), orcamento_itens (*)`).eq('id', id).single(); if (error) return showNotification('Erro ao buscar detalhes.', 'error'); state.orcamentoSelecionado = data; displayOrcamentoDetails(); };
            const displayOrcamentoDetails = () => {
                if (!state.orcamentoSelecionado) { detalhesContainer.style.display = 'none'; return; }
                const orc = state.orcamentoSelecionado;
                const { status } = orc;

                $('#detalhes-orcamento-texto').textContent = generateOrcamentoText(orc);
                $('#btn-aprovar').style.display = status === 'Or√ßamento' ? 'inline-block' : 'none';
                $('#btn-finalizar').style.display = status === 'Aprovado' ? 'inline-block' : 'none';
                $('#btn-cancelar').style.display = status === 'Or√ßamento' || status === 'Aprovado' ? 'inline-block' : 'none';
                
                const reciboBtn = $('#btn-view-recibo');
                if (status === 'Finalizado') {
                    $('#detalhes-recibo-texto').textContent = generateReciboText(orc);
                    reciboBtn.style.display = 'inline-block';
                } else {
                    reciboBtn.style.display = 'none';
                    switchDetailView('orcamento');
                }
                detalhesContainer.style.display = 'block';
                detalhesContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            };

            const switchDetailView = (view) => {
                if (view === 'orcamento') {
                    $('#detalhe-orcamento-bloco').style.display = 'block';
                    $('#detalhe-recibo-bloco').style.display = 'none';
                    $('#btn-view-orcamento').classList.add('active');
                    $('#btn-view-recibo').classList.remove('active');
                } else {
                    $('#detalhe-orcamento-bloco').style.display = 'none';
                    $('#detalhe-recibo-bloco').style.display = 'block';
                    $('#btn-view-orcamento').classList.remove('active');
                    $('#btn-view-recibo').classList.add('active');
                }
            };

            const updateStatusOrcamento = async (newStatus) => { if (!state.orcamentoSelecionado) return; const { error } = await db.from('orcamentos').update({ status: newStatus, updated_at: new Date().toISOString() }).eq('id', state.orcamentoSelecionado.id); if (error) showNotification('Erro ao atualizar status.', 'error'); else { showNotification(`Or√ßamento ${newStatus.toLowerCase()}!`); state.orcamentoSelecionado.status = newStatus; state.orcamentoSelecionado.updated_at = new Date().toISOString(); displayOrcamentoDetails(); fetchAllData(); } };
            const handleDeleteOrcamento = () => showConfirmModal('Excluir Or√ßamento', 'Esta a√ß√£o √© irrevers√≠vel. O or√ßamento ser√° permanentemente removido.', async () => { if (!state.orcamentoSelecionado) return; const { error } = await db.from('orcamentos').delete().eq('id', state.orcamentoSelecionado.id); if (error) showNotification(`Erro ao excluir or√ßamento: ${error.message}`, 'error'); else { showNotification('Or√ßamento exclu√≠do.'); state.orcamentoSelecionado = null; displayOrcamentoDetails(); fetchAllData(); } hideConfirmModal(); });
            
            const generateFooter = () => `\n==================================\n*${ESTABELECIMENTO.nome}*\nüìç ${ESTABELECIMENTO.endereco}\n*üìû Contato:* ${formatPhone(ESTABELECIMENTO.telefone)}\n\n_${ESTABELECIMENTO.agradecimento}_`;
            const generateOrcamentoText = (orc) => { const subtotal = orc.orcamento_itens.reduce((acc, item) => acc + parseFloat(item.valor_cobrado), 0); const servicosText = orc.orcamento_itens.map(item => `- ${item.descricao_servico} (${formatCurrency(item.valor_cobrado)})`).join('\n'); return `*Or√ßamento - ${ESTABELECIMENTO.nome}*\n==================================\n*Data:* ${formatDateTime(orc.created_at)}\n*Cliente:* ${orc.clientes?.nome || 'N/A'}\n\n*SERVI√áOS:*\n${servicosText}\n\n*Subtotal:* ${formatCurrency(subtotal)}\n*Desconto:* ${orc.desconto || 0}%\n*VALOR TOTAL:* ${formatCurrency(orc.valor_total)}\n\n*Formas de Pagamento:* ${orc.formas_pagamento || 'N√£o especificado'}` + generateFooter(); };
            const generateReciboText = (orc) => { const servicosText = orc.orcamento_itens.map(item => `- ${item.descricao_servico}`).join('\n'); return `*Recibo de Servi√ßo (N√£o Fiscal)*\n==================================\n*Data da Finaliza√ß√£o:* ${formatDateTime(orc.updated_at)}\n*Cliente:* ${orc.clientes?.nome || 'N/A'}\n\n*Servi√ßo(s) Realizado(s):*\n${servicosText}\n\n*Valor Pago:* ${formatCurrency(orc.valor_total)}` + generateFooter(); };
            
            const init = () => {
                $$('.nav-btn').forEach(b => b.addEventListener('click', () => showTab(b.dataset.tab)));
                syncBtn.addEventListener('click', fetchAllData);
                clienteForm.addEventListener('submit', handleClienteSubmit);
                $('#cancelar-edicao-cliente').addEventListener('click', resetClienteForm);
                clientesLista.addEventListener('click', (e) => { const id = e.target.closest('[data-id]')?.dataset.id; if (!id) return; if (e.target.closest('.edit-cliente-btn')) handleEditCliente(id); if (e.target.closest('.delete-cliente-btn')) handleDeleteCliente(id); });
                servicoForm.addEventListener('submit', handleServicoSubmit);
                $('#cancelar-edicao-servico').addEventListener('click', resetServicoForm);
                servicosLista.addEventListener('click', (e) => { const id = e.target.closest('[data-id]')?.dataset.id; if (!id) return; if (e.target.closest('.edit-servico-btn')) handleEditServico(id); if (e.target.closest('.delete-servico-btn')) handleDeleteServico(id); });
                addServicoBtn.addEventListener('click', handleAddServicoToOrcamento);
                orcamentoServicosAdicionados.addEventListener('click', (e) => { if (e.target.classList.contains('remove-servico-btn')) handleRemoveServicoFromOrcamento(e.target.dataset.index); });
                orcamentoDescontoInput.addEventListener('input', updateOrcamentoTotal);
                orcamentoForm.addEventListener('submit', handleOrcamentoSubmit);
                paymentOptionsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('payment-option')) e.target.classList.toggle('active'); });

                historicoLista.addEventListener('click', (e) => { const li = e.target.closest('li'); if (li?.dataset.id) handleHistoricoClick(li.dataset.id); });
                recentActivityList.addEventListener('click', (e) => { const li = e.target.closest('li[data-id]'); if(li) { showTab('historico'); setTimeout(() => handleHistoricoClick(li.dataset.id), 50); }});
                
                $('#btn-aprovar').addEventListener('click', () => updateStatusOrcamento('Aprovado'));
                $('#btn-finalizar').addEventListener('click', () => updateStatusOrcamento('Finalizado'));
                $('#btn-cancelar').addEventListener('click', () => updateStatusOrcamento('Cancelado'));
                $('#btn-excluir-orcamento').addEventListener('click', handleDeleteOrcamento);
                
                $('#btn-view-orcamento').addEventListener('click', () => switchDetailView('orcamento'));
                $('#btn-view-recibo').addEventListener('click', () => switchDetailView('recibo'));

                const copyAndNotify = (textGenerator, type) => { if (!state.orcamentoSelecionado) return; const text = textGenerator(state.orcamentoSelecionado); navigator.clipboard.writeText(text).then(() => showNotification(`${type} copiado!`), () => showNotification(`Erro ao copiar ${type}.`, 'error')); };
                const sendWhatsApp = (textGenerator) => { if (!state.orcamentoSelecionado) return; const text = textGenerator(state.orcamentoSelecionado); const phone = cleanPhone(state.orcamentoSelecionado.clientes?.telefone); let url = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`; if (phone && phone.length > 10) { url = `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(text)}`; } window.open(url, '_blank'); };
                
                $('#btn-copiar-orcamento').addEventListener('click', () => copyAndNotify(generateOrcamentoText, 'Or√ßamento'));
                $('#btn-whatsapp-orcamento').addEventListener('click', () => sendWhatsApp(generateOrcamentoText));
                $('#btn-copiar-recibo').addEventListener('click', () => copyAndNotify(generateReciboText, 'Recibo'));
                $('#btn-whatsapp-recibo').addEventListener('click', () => sendWhatsApp(generateReciboText));
                
                modalCancelBtn.addEventListener('click', hideConfirmModal);
                modalConfirmBtn.addEventListener('click', () => { if (typeof onConfirmCallback === 'function') onConfirmCallback(); });
                
                searchClienteInput.addEventListener('input', renderClientes);
                searchServicoInput.addEventListener('input', renderServicos);
                searchHistoricoInput.addEventListener('input', renderOrcamentos);
                clienteTelefoneInput.addEventListener('input', (e) => { e.target.value = formatPhone(e.target.value); });

                // Back to Top Button Logic
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 300) {
                        backToTopBtn.classList.add('show');
                    } else {
                        backToTopBtn.classList.remove('show');
                    }
                });
                backToTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                
                showTab('dashboard');
                fetchAllData();
            };

            init();
        });
    </script>
</body>
</html>
