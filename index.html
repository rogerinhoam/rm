<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R.M. Est√©tica Automotiva - Gestor PRO (Diagn√≥stico)</title>
    
    <!-- Importa o cliente Supabase via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Estilos CSS (sem altera√ß√µes) -->
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --bg-card: #2c2c2c;
            --bg-input: #3a3a3a;
            --text-light: #f0f0f0;
            --text-muted: #a0a0a0;
            --primary-red: #e53935;
            --primary-red-dark: #c62828;
            --green: #43a047;
            --green-dark: #2e7d32;
            --blue: #1e88e5;
            --orange: #fb8c00;
            --red-status: #d32f2f;
            --border-color: #444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            font-size: 16px;
        }

        .app-container { max-width: 1200px; margin: 0 auto; padding: 15px; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-red);
            padding-bottom: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        header h1 { color: var(--primary-red); font-size: 1.5rem; }

        nav { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; justify-content: flex-start; }

        .nav-btn {
            padding: 10px 15px;
            background-color: var(--bg-card);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-size: 0.9rem;
            flex-grow: 1;
            text-align: center;
        }

        .nav-btn:hover { background-color: var(--primary-red-dark); }
        .nav-btn.active { background-color: var(--primary-red); color: white; font-weight: bold; }
        
        .sync-btn {
            background: none; border: none; color: var(--text-muted); cursor: pointer;
            font-size: 1.8rem; transition: color 0.3s, transform 0.3s;
        }
        .sync-btn.syncing { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .grid-layout { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 800px) { .grid-layout { grid-template-columns: 1fr 2fr; } }

        .card { background-color: var(--bg-card); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        
        .card h2 {
            margin-top: 0; margin-bottom: 20px; color: var(--primary-red);
            border-bottom: 1px solid var(--border-color); padding-bottom: 10px; font-size: 1.2rem;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; }
        .search-container { position: relative; margin-bottom: 15px; }
        .search-container input { padding-left: 35px; }
        .search-container::before { content: 'üîé'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        input, select {
            width: 100%; padding: 12px; background-color: var(--bg-input);
            border: 1px solid var(--border-color); border-radius: 6px;
            color: var(--text-light); font-size: 1rem;
        }

        .btn {
            display: inline-block; padding: 12px 20px; border: none; border-radius: 6px;
            cursor: pointer; font-weight: bold; text-transform: uppercase;
            font-size: 0.9rem; transition: background-color 0.3s, transform 0.1s;
            width: 100%; margin-top: 5px;
        }
        
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-red); color: white; }
        .btn-primary:hover { background-color: var(--primary-red-dark); }
        .btn-secondary { background-color: #555; color: white; }
        .btn-secondary:hover { background-color: #666; }
        .btn-danger { background-color: var(--red-status); color: white; }
        .btn-success { background-color: var(--green); color: white; }
        .btn-success:hover { background-color: var(--green-dark); }
        .btn-sm { padding: 8px 12px; font-size: 0.8rem; width: auto; }

        .data-list ul { list-style: none; padding: 0; max-height: 500px; overflow-y: auto; }
        .data-list li {
            display: flex; justify-content: space-between; align-items: center; padding: 12px;
            background-color: var(--bg-input); border-bottom: 1px solid var(--border-color);
            border-radius: 6px; margin-bottom: 8px; flex-wrap: wrap; gap: 10px;
        }
        .data-list li > div:first-child { flex-grow: 1; }
        .item-actions { display: flex; gap: 10px; flex-shrink: 0; }
        
        #orcamento-total { margin-top: 20px; font-size: 1.5rem; font-weight: bold; color: var(--primary-red); text-align: center; }
        .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .checkbox-group label { display: flex; align-items: center; gap: 5px; }
        
        .historico-layout { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 992px) { .historico-layout { grid-template-columns: 1fr 1.5fr; } .btn { width: auto; } }

        #historico-lista li { cursor: pointer; transition: background-color 0.3s; }
        #historico-lista li:hover, #historico-lista li.selected { background-color: var(--primary-red-dark); }
        .status-indicator { padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; color: white; font-weight: bold; margin-right: 10px; }
        .status-Or√ßamento { background-color: var(--blue); }
        .status-Aprovado { background-color: var(--orange); }
        .status-Finalizado { background-color: var(--green); }
        .status-Cancelado { background-color: var(--red-status); }

        .detalhe-bloco {
            background-color: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 15px; margin-top: 20px;
        }
        .detalhe-bloco h3 { margin-top: 0; margin-bottom: 10px; color: var(--text-muted); font-size: 1rem; }
        .detalhe-bloco pre {
            white-space: pre-wrap; word-wrap: break-word; color: var(--text-light);
            font-family: 'Courier New', Courier, monospace; font-size: 0.9rem;
            background-color: var(--bg-input); padding: 10px; border-radius: 4px;
        }
        .detalhe-bloco-actions { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
        .detalhes-status-actions { display: flex; flex-wrap: wrap; gap: 10px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-card { background-color: var(--bg-card); border-radius: 8px; padding: 20px; text-align: center; border: 1px solid var(--border-color); }
        .stat-card .icon { font-size: 2.5rem; margin-bottom: 10px; }
        .stat-card h3 { font-size: 1rem; color: var(--text-muted); margin-bottom: 5px; }
        .stat-card p { font-size: 2rem; font-weight: bold; color: var(--primary-red); }

        #notification {
            position: fixed; bottom: 20px; left: 50%; transform: translate(-50%, 150%);
            padding: 15px 20px; border-radius: 8px; color: white; z-index: 1000;
            text-align: center; visibility: hidden; transition: transform 0.5s, visibility 0.5s;
            max-width: 90%;
        }
        #notification.show { transform: translate(-50%, 0); visibility: visible; }
        #notification.success { background-color: var(--green); }
        #notification.error { background-color: var(--red-status); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); display: none; justify-content: center;
            align-items: center; z-index: 2000; padding: 15px;
        }
        .modal-content {
            background-color: var(--bg-card); padding: 25px; border-radius: 8px;
            text-align: center; max-width: 400px; width: 100%;
            border: 1px solid var(--border-color);
        }
        .modal-content h3 { margin-bottom: 15px; color: var(--primary-red); }
        .modal-content p { margin-bottom: 25px; }
        .modal-actions { display: flex; justify-content: center; gap: 15px; }
    </style>
</head>
<body>

    <!-- O HTML do corpo da p√°gina permanece o mesmo -->
    <div class="app-container">
        <header>
            <h1>üöó R.M. Est√©tica PRO</h1>
            <button class="sync-btn" id="sync-btn" title="Sincronizar Dados">üîÑ</button>
        </header>

        <nav>
            <button class="nav-btn active" data-tab="dashboard">Painel üìä</button>
            <button class="nav-btn" data-tab="clientes">Clientes üë•</button>
            <button class="nav-btn" data-tab="servicos">Servi√ßos üõ†Ô∏è</button>
            <button class="nav-btn" data-tab="novo-orcamento">Or√ßamento üìù</button>
            <button class="nav-btn" data-tab="historico">Hist√≥rico üìÇ</button>
        </nav>

        <main>
            <section id="dashboard-tab" class="tab-content active">
                <div class="card">
                    <h2>Vis√£o Geral</h2>
                    <div class="dashboard-grid">
                        <div class="stat-card"><div class="icon">üë•</div><h3>Total de Clientes</h3><p id="stat-clientes">0</p></div>
                        <div class="stat-card"><div class="icon">üìù</div><h3>Or√ßamentos Pendentes</h3><p id="stat-pendentes">0</p></div>
                        <div class="stat-card"><div class="icon">üëç</div><h3>Servi√ßos Aprovados</h3><p id="stat-aprovados">0</p></div>
                        <div class="stat-card"><div class="icon">‚úÖ</div><h3>Servi√ßos Finalizados (M√™s)</h3><p id="stat-finalizados-mes">0</p></div>
                    </div>
                </div>
            </section>
            
            <section id="clientes-tab" class="tab-content">
                 <div class="grid-layout">
                    <div class="card">
                        <h2 id="cliente-form-title">Novo Cliente üßë‚Äçü§ù‚Äçüßë</h2>
                        <form id="cliente-form">
                            <input type="hidden" id="cliente-id">
                            <div class="form-group"><label for="cliente-nome">Nome Completo</label><input type="text" id="cliente-nome" required></div>
                            <div class="form-group"><label for="cliente-telefone">Telefone (com DDD)</label><input type="tel" id="cliente-telefone" placeholder="(24) 99999-8888"></div>
                            <div class="form-group"><label for="cliente-carro">Ve√≠culo</label><input type="text" id="cliente-carro"></div>
                            <div class="form-group"><label for="cliente-placa">Placa</label><input type="text" id="cliente-placa"></div>
                            <button type="submit" class="btn btn-primary">Salvar üíæ</button>
                            <button type="button" id="cancelar-edicao-cliente" class="btn btn-secondary" style="display: none;">Cancelar</button>
                        </form>
                    </div>
                    <div class="card data-list">
                        <h2>Clientes Cadastrados</h2>
                        <div class="search-container"><input type="search" id="search-cliente" placeholder="Buscar cliente por nome ou placa..."></div>
                        <ul id="clientes-lista"></ul>
                    </div>
                </div>
            </section>
            
            <section id="servicos-tab" class="tab-content">
                 <div class="grid-layout">
                    <div class="card">
                        <h2 id="servico-form-title">Novo Servi√ßo üìã</h2>
                        <form id="servico-form">
                            <input type="hidden" id="servico-id">
                            <div class="form-group"><label for="servico-descricao">Descri√ß√£o</label><input type="text" id="servico-descricao" required></div>
                            <div class="form-group"><label for="servico-valor">Valor (R$)</label><input type="number" id="servico-valor" step="0.01" required></div>
                            <button type="submit" class="btn btn-primary">Salvar üíæ</button>
                            <button type="button" id="cancelar-edicao-servico" class="btn btn-secondary" style="display: none;">Cancelar</button>
                        </form>
                    </div>
                     <div class="card data-list">
                        <h2>Servi√ßos Cadastrados</h2>
                        <div class="search-container"><input type="search" id="search-servico" placeholder="Buscar servi√ßo..."></div>
                        <ul id="servicos-lista"></ul>
                    </div>
                </div>
            </section>

            <section id="novo-orcamento-tab" class="tab-content">
                <div class="card">
                    <h2>Criar Novo Or√ßamento ‚úçÔ∏è</h2>
                    <form id="orcamento-form">
                        <div class="form-group"><label for="orcamento-cliente">Cliente</label><select id="orcamento-cliente" required></select></div>
                        <div class="form-group"><label for="orcamento-servico-select">Adicionar Servi√ßo</label><div style="display: flex; gap: 10px;"><select id="orcamento-servico-select" style="flex-grow: 1;"></select><button type="button" id="add-servico-btn" class="btn btn-primary btn-sm" style="width: 50px;">+</button></div></div>
                        <h3>Servi√ßos Adicionados</h3><ul id="orcamento-servicos-adicionados" style="min-height: 50px; list-style: none; padding: 0;"></ul>
                        <div class="form-group" style="margin-top: 20px;"><label for="orcamento-desconto">Desconto (%)</label><input type="number" id="orcamento-desconto" value="0" min="0" max="100"></div>
                        <div class="form-group"><label>Formas de Pagamento</label><div class="checkbox-group"><label><input type="checkbox" name="pagamento" value="Pix"> Pix</label><label><input type="checkbox" name="pagamento" value="Dinheiro"> Dinheiro</label><label><input type="checkbox" name="pagamento" value="Cr√©dito"> Cr√©dito</label><label><input type="checkbox" name="pagamento" value="D√©bito"> D√©bito</label></div></div>
                        <div id="orcamento-total">TOTAL: R$ 0,00</div>
                        <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Salvar Or√ßamento üíæ</button>
                    </form>
                </div>
            </section>

            <section id="historico-tab" class="tab-content">
                <div class="historico-layout">
                    <div class="card data-list">
                        <h2>Hist√≥rico de Servi√ßos</h2>
                        <div class="search-container"><input type="search" id="search-historico" placeholder="Buscar por cliente..."></div>
                        <ul id="historico-lista"></ul>
                    </div>
                    <div class="card" id="detalhes-orcamento-container" style="display: none;">
                        <h2>Detalhes do Servi√ßo üîé</h2>
                        
                        <div class="detalhes-status-actions">
                             <button id="btn-aprovar" class="btn btn-sm" style="background-color: var(--orange)">Aprovar üëç</button>
                             <button id="btn-finalizar" class="btn btn-sm" style="background-color: var(--green)">Finalizar ‚úÖ</button>
                             <button id="btn-cancelar" class="btn btn-sm" style="background-color: var(--red-status);">Cancelar üëé</button>
                             <button id="btn-excluir-orcamento" class="btn btn-sm btn-danger">Excluir üóëÔ∏è</button>
                        </div>
                        
                        <div id="detalhe-orcamento-bloco" class="detalhe-bloco">
                           <h3>Or√ßamento</h3>
                           <pre id="detalhes-orcamento-texto"></pre>
                           <div class="detalhe-bloco-actions">
                               <button id="btn-copiar-orcamento" class="btn btn-sm btn-secondary">Copiar üìã</button>
                               <button id="btn-whatsapp-orcamento" class="btn btn-sm btn-success">WhatsApp üí¨</button>
                           </div>
                        </div>

                        <div id="detalhe-recibo-bloco" class="detalhe-bloco" style="display: none;">
                            <h3>Recibo de Servi√ßo</h3>
                            <pre id="detalhes-recibo-texto"></pre>
                            <div class="detalhe-bloco-actions">
                                <button id="btn-copiar-recibo" class="btn btn-sm btn-secondary">Copiar üìã</button>
                                <button id="btn-whatsapp-recibo" class="btn btn-sm btn-success">WhatsApp üí¨</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <div id="notification"></div>
    
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">Confirmar A√ß√£o</h3>
            <p id="modal-message">Voc√™ tem certeza?</p>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="btn btn-secondary">Cancelar</button>
                <button id="modal-confirm-btn" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>


    <script type="module">
        // ===================================================================================
        // DADOS DO ESTABELECIMENTO
        // ===================================================================================
        const ESTABELECIMENTO = {
            nome: "R.M. Est√©tica Automotiva",
            telefone: "(24) 99948-6232",
            endereco: "Rua 40, TV - Recanto dos P√°ssaros, Pq. Mambucaba, Angra dos Reis - RJ",
            agradecimento: "Obrigado pela prefer√™ncia e volte sempre! üëç"
        };

        // ===================================================================================
        // CONFIGURA√á√ÉO DO SUPABASE
        // ===================================================================================
        const SUPABASE_URL = 'https://uymunsavnpfcsuznrugi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5bXVuc2F2bnBmY3N1em5ydWdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3ODU3ODgsImV4cCI6MjA2NjM2MTc4OH0.Kz__-jB9SsD-w7SuwlYCWPuEOcOX9epRE9CB5jd4eFY';
        
        if (!SUPABASE_URL || !SUPABASE_KEY) {
            document.body.innerHTML = `<div style="padding: 40px; text-align: center; font-size: 1.2rem; color: #ffcc00; background-color: #333; height: 100vh;"><h1>Erro de Configura√ß√£o</h1><p>As credenciais do Supabase n√£o foram encontradas.</p></div>`;
            throw new Error("Credenciais do Supabase n√£o configuradas.");
        }

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ===================================================================================
        // MODO DE DIAGN√ìSTICO ATIVADO
        // ===================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // O c√≥digo principal da aplica√ß√£o permanece o mesmo...
            let state = {
                clientes: [], servicos: [], orcamentos: [],
                editandoClienteId: null, editandoServicoId: null,
                novoOrcamentoItens: [], orcamentoSelecionado: null,
                isSyncing: false
            };

            const $ = (s) => document.querySelector(s);
            // ... (restante dos seletores e fun√ß√µes utilit√°rias) ...
            const showNotification = (message, type = 'success') => { console.log(`${type.toUpperCase()}: ${message}`); alert(`${type.toUpperCase()}: ${message}`); };


            // =====================================================================
            // AQUI EST√Å A MUDAN√áA PRINCIPAL PARA O DIAGN√ìSTICO
            // =====================================================================
            const fetchAllData = async () => {
                if (state.isSyncing) return;
                state.isSyncing = true;
                const syncBtn = $('#sync-btn');
                syncBtn.classList.add('syncing');
                console.log("--- INICIANDO DIAGN√ìSTICO DE SINCRONIZA√á√ÉO ---");

                let success = true;

                // Teste 1: Tabela de Clientes
                try {
                    console.log("1. A tentar buscar dados da tabela 'clientes'...");
                    const { data, error } = await db.from('clientes').select('*').limit(1);
                    if (error) throw error;
                    console.log("   SUCESSO: Conex√£o com 'clientes' estabelecida. Recebido:", data);
                    state.clientes = (await db.from('clientes').select('*').order('nome', { ascending: true })).data;
                } catch (error) {
                    console.error("   ERRO ao buscar dados de 'clientes':", error.message);
                    showNotification("Falha ao buscar clientes. Verifique o Console (F12) para detalhes.", "error");
                    success = false;
                }

                // Teste 2: Tabela de Servi√ßos
                try {
                    console.log("2. A tentar buscar dados da tabela 'servicos'...");
                    const { data, error } = await db.from('servicos').select('*').limit(1);
                    if (error) throw error;
                    console.log("   SUCESSO: Conex√£o com 'servicos' estabelecida. Recebido:", data);
                    state.servicos = (await db.from('servicos').select('*').order('descricao', { ascending: true })).data;
                } catch (error) {
                    console.error("   ERRO ao buscar dados de 'servicos':", error.message);
                    showNotification("Falha ao buscar servi√ßos. Verifique o Console (F12) para detalhes.", "error");
                    success = false;
                }

                // Teste 3: Tabela de Or√ßamentos com Rela√ß√µes
                try {
                    console.log("3. A tentar buscar dados da tabela 'orcamentos' com rela√ß√£o a 'clientes'...");
                    const query = 'id, created_at, updated_at, valor_total, status, clientes ( nome )';
                    console.log(`   Executando a query: .from('orcamentos').select('${query}')`);
                    const { data, error } = await db.from('orcamentos').select(query).limit(1);
                    if (error) throw error;
                    console.log("   SUCESSO: Conex√£o com 'orcamentos' e 'clientes' estabelecida. Recebido:", data);
                    state.orcamentos = (await db.from('orcamentos').select(query).order('created_at', { ascending: false })).data;
                } catch (error) {
                    console.error("   ERRO ao buscar dados de 'orcamentos' (pode ser problema de rela√ß√£o/FK):", error.message);
                    showNotification("Falha ao buscar hist√≥rico de or√ßamentos. Verifique o Console (F12).", "error");
                    success = false;
                }
                
                if(success) {
                   console.log("--- DIAGN√ìSTICO CONCLU√çDO: Todas as tabelas responderam com sucesso! ---");
                   showNotification("Sincroniza√ß√£o bem-sucedida!", "success");
                   // A fun√ß√£o renderAll s√≥ √© chamada se tudo correr bem
                   renderAll(); 
                } else {
                   console.error("--- DIAGN√ìSTICO CONCLU√çDO: Foram encontrados erros. Verifique as mensagens de ERRO acima. ---");
                }

                state.isSyncing = false;
                syncBtn.classList.remove('syncing');
            };


            // O resto do c√≥digo (renderAll, fun√ß√µes de formul√°rio, etc.) permanece o mesmo.
            // Apenas a fun√ß√£o fetchAllData foi substitu√≠da pela vers√£o de diagn√≥stico.
            
            // --- Fun√ß√µes de Renderiza√ß√£o (Exemplo) ---
            const renderAll = () => { renderClientes(); renderServicos(); renderOrcamentos(); renderOrcamentoClienteOptions(); renderOrcamentoServicoOptions(); updateDashboard(); };
            const renderClientes = () => { $('#clientes-lista').innerHTML = state.clientes.map(c => `<li>${c.nome}</li>`).join(''); };
            const renderServicos = () => { $('#servicos-lista').innerHTML = state.servicos.map(s => `<li>${s.descricao}</li>`).join(''); };
            const renderOrcamentos = () => { $('#historico-lista').innerHTML = state.orcamentos.map(o => `<li>${o.clientes?.nome || 'Cliente'} - ${o.status}</li>`).join(''); };
            const updateDashboard = () => { $('#stat-clientes').textContent = state.clientes.length; /* ... */ };
            const renderOrcamentoClienteOptions = () => {};
            const renderOrcamentoServicoOptions = () => {};


            // --- Inicializa√ß√£o ---
            // Substitu√≠mos o init() original para simplificar, o importante √© chamar o fetchAllData de diagn√≥stico.
            console.log("Aplica√ß√£o iniciada, a executar o diagn√≥stico...");
            fetchAllData();

            // Adiciona um listener ao bot√£o de sync para poder re-testar
            $('#sync-btn').addEventListener('click', fetchAllData);

        });
    </script>
</body>
</html>
