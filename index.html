<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R.M. Est√©tica Automotiva - Gestor</title>
    
    <!-- Importa o cliente Supabase via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Estilos CSS -->
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --bg-card: #2c2c2c;
            --bg-input: #3a3a3a;
            --text-light: #f0f0f0;
            --text-muted: #a0a0a0;
            --primary-red: #e53935;
            --primary-red-dark: #c62828;
            --green: #43a047;
            --green-dark: #2e7d32;
            --blue: #1e88e5;
            --orange: #fb8c00;
            --red-status: #d32f2f;
            --border-color: #444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            font-size: 16px;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-red);
            padding-bottom: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        header h1 {
            color: var(--primary-red);
            font-size: 1.5rem;
        }

        nav {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .nav-btn {
            padding: 10px 15px;
            background-color: var(--bg-card);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-size: 0.9rem;
            flex-grow: 1;
            text-align: center;
        }

        .nav-btn:hover {
            background-color: var(--primary-red-dark);
        }
        
        .nav-btn.active {
            background-color: var(--primary-red);
            color: white;
            font-weight: bold;
        }
        
        .sync-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.8rem;
            transition: color 0.3s, transform 0.3s;
        }

        .sync-btn:hover {
            color: var(--primary-red);
            transform: rotate(90deg);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 800px) {
            .grid-layout {
                grid-template-columns: 1fr 2fr;
            }
        }

        .card {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .card h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-red);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 12px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 1rem;
        }

        .btn {
            display: inline-block;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            transition: background-color 0.3s, transform 0.1s;
            width: 100%;
            margin-top: 5px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary { background-color: var(--primary-red); color: white; }
        .btn-primary:hover { background-color: var(--primary-red-dark); }
        .btn-secondary { background-color: #555; color: white; }
        .btn-secondary:hover { background-color: #666; }
        .btn-danger { background-color: var(--red-status); color: white; }
        .btn-success { background-color: var(--green); color: white; }
        .btn-success:hover { background-color: var(--green-dark); }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.8rem;
            width: auto;
        }

        .data-list ul {
            list-style: none;
            padding: 0;
            max-height: 500px;
            overflow-y: auto;
        }

        .data-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: var(--bg-input);
            border-bottom: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .data-list li > div:first-child { flex-grow: 1; }
        .item-actions { display: flex; gap: 10px; flex-shrink: 0; }
        
        #orcamento-total {
            margin-top: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-red);
            text-align: center;
        }

        .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .checkbox-group label { display: flex; align-items: center; gap: 5px; }
        
        .historico-layout { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 992px) {
            .historico-layout { grid-template-columns: 1fr 1.5fr; }
            .btn { width: auto; }
        }

        #historico-lista li { cursor: pointer; transition: background-color 0.3s; }
        #historico-lista li:hover, #historico-lista li.selected { background-color: var(--primary-red-dark); }
        .status-indicator { padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; color: white; font-weight: bold; margin-right: 10px; }
        .status-Or√ßamento { background-color: var(--blue); }
        .status-Aprovado { background-color: var(--orange); }
        .status-Finalizado { background-color: var(--green); }
        .status-Cancelado { background-color: var(--red-status); }

        .detalhe-bloco {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .detalhe-bloco h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--text-muted);
            font-size: 1rem;
        }
        .detalhe-bloco pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-light);
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            background-color: var(--bg-input);
            padding: 10px;
            border-radius: 4px;
        }
        .detalhe-bloco-actions { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
        
        .detalhes-status-actions { display: flex; flex-wrap: wrap; gap: 10px; }

        #notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            transform: translateY(150%);
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            text-align: center;
            visibility: hidden;
            transition: transform 0.5s, visibility 0.5s;
        }
        #notification.show { transform: translateY(0); visibility: visible; }
        #notification.success { background-color: var(--green); }
        #notification.error { background-color: var(--red-status); }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h1>üöó R.M. Est√©tica Automotiva</h1>
            <button class="sync-btn" id="sync-btn" title="Sincronizar Dados">üîÑ</button>
        </header>

        <nav>
            <button class="nav-btn active" data-tab="clientes">Clientes üë•</button>
            <button class="nav-btn" data-tab="servicos">Servi√ßos üõ†Ô∏è</button>
            <button class="nav-btn" data-tab="novo-orcamento">Or√ßamento üìù</button>
            <button class="nav-btn" data-tab="historico">Hist√≥rico üìÇ</button>
        </nav>

        <main>
            <!-- Abas de Clientes, Servi√ßos e Novo Or√ßamento -->
            <section id="clientes-tab" class="tab-content active">
                 <div class="grid-layout">
                    <div class="card">
                        <h2 id="cliente-form-title">Novo Cliente üßë‚Äçü§ù‚Äçüßë</h2>
                        <form id="cliente-form">
                            <input type="hidden" id="cliente-id">
                            <div class="form-group"><label for="cliente-nome">Nome Completo</label><input type="text" id="cliente-nome" required></div>
                            <div class="form-group"><label for="cliente-telefone">Telefone (com DDD)</label><input type="text" id="cliente-telefone" placeholder="Ex: 24999998888"></div>
                            <div class="form-group"><label for="cliente-carro">Ve√≠culo</label><input type="text" id="cliente-carro"></div>
                            <div class="form-group"><label for="cliente-placa">Placa</label><input type="text" id="cliente-placa"></div>
                            <button type="submit" class="btn btn-primary">Salvar üíæ</button>
                            <button type="button" id="cancelar-edicao-cliente" class="btn btn-secondary" style="display: none;">Cancelar</button>
                        </form>
                    </div>
                    <div class="card data-list"><h2>Clientes Cadastrados</h2><ul id="clientes-lista"></ul></div>
                </div>
            </section>
            <section id="servicos-tab" class="tab-content">
                 <div class="grid-layout">
                    <div class="card">
                        <h2 id="servico-form-title">Novo Servi√ßo üìã</h2>
                        <form id="servico-form">
                            <input type="hidden" id="servico-id">
                            <div class="form-group"><label for="servico-descricao">Descri√ß√£o</label><input type="text" id="servico-descricao" required></div>
                            <div class="form-group"><label for="servico-valor">Valor (R$)</label><input type="number" id="servico-valor" step="0.01" required></div>
                            <button type="submit" class="btn btn-primary">Salvar üíæ</button>
                            <button type="button" id="cancelar-edicao-servico" class="btn btn-secondary" style="display: none;">Cancelar</button>
                        </form>
                    </div>
                    <div class="card data-list"><h2>Servi√ßos Cadastrados</h2><ul id="servicos-lista"></ul></div>
                </div>
            </section>
            <section id="novo-orcamento-tab" class="tab-content">
                <div class="card">
                    <h2>Criar Novo Or√ßamento ‚úçÔ∏è</h2>
                    <form id="orcamento-form">
                        <div class="form-group"><label for="orcamento-cliente">Cliente</label><select id="orcamento-cliente" required></select></div>
                        <div class="form-group"><label for="orcamento-servico-select">Adicionar Servi√ßo</label><div style="display: flex; gap: 10px;"><select id="orcamento-servico-select" style="flex-grow: 1;"></select><button type="button" id="add-servico-btn" class="btn btn-primary btn-sm" style="width: 50px;">+</button></div></div>
                        <h3>Servi√ßos Adicionados</h3><ul id="orcamento-servicos-adicionados" style="min-height: 50px;"></ul>
                        <div class="form-group" style="margin-top: 20px;"><label for="orcamento-desconto">Desconto (%)</label><input type="number" id="orcamento-desconto" value="0" min="0" max="100"></div>
                        <div class="form-group"><label>Formas de Pagamento</label><div class="checkbox-group"><label><input type="checkbox" name="pagamento" value="Pix"> Pix</label><label><input type="checkbox" name="pagamento" value="Dinheiro"> Dinheiro</label><label><input type="checkbox" name="pagamento" value="Cr√©dito"> Cr√©dito</label><label><input type="checkbox" name="pagamento" value="D√©bito"> D√©bito</label></div></div>
                        <div id="orcamento-total">TOTAL: R$ 0,00</div>
                        <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Salvar Or√ßamento üíæ</button>
                    </form>
                </div>
            </section>

            <!-- Aba Hist√≥rico (MODIFICADA) -->
            <section id="historico-tab" class="tab-content">
                <div class="historico-layout">
                    <div class="card data-list">
                        <h2>Hist√≥rico de Servi√ßos</h2>
                        <ul id="historico-lista"></ul>
                    </div>
                    <div class="card" id="detalhes-orcamento-container" style="display: none;">
                        <h2>Detalhes do Servi√ßo üîé</h2>
                        
                        <div class="detalhes-status-actions">
                             <button id="btn-aprovar" class="btn btn-sm" style="background-color: var(--orange)">Aprovar üëç</button>
                             <button id="btn-finalizar" class="btn btn-sm" style="background-color: var(--green)">Finalizar ‚úÖ</button>
                             <button id="btn-excluir-orcamento" class="btn btn-sm btn-danger">Excluir üóëÔ∏è</button>
                        </div>
                        
                        <!-- Bloco do Or√ßamento -->
                        <div id="detalhe-orcamento-bloco" class="detalhe-bloco">
                           <h3>Or√ßamento</h3>
                           <pre id="detalhes-orcamento-texto"></pre>
                           <div class="detalhe-bloco-actions">
                               <button id="btn-copiar-orcamento" class="btn btn-sm btn-secondary">Copiar üìã</button>
                               <button id="btn-whatsapp-orcamento" class="btn btn-sm btn-success">WhatsApp üí¨</button>
                           </div>
                        </div>

                        <!-- Bloco do Recibo (inicialmente oculto) -->
                        <div id="detalhe-recibo-bloco" class="detalhe-bloco" style="display: none;">
                            <h3>Recibo de Servi√ßo</h3>
                            <pre id="detalhes-recibo-texto"></pre>
                            <div class="detalhe-bloco-actions">
                                <button id="btn-copiar-recibo" class="btn btn-sm btn-secondary">Copiar üìã</button>
                                <button id="btn-whatsapp-recibo" class="btn btn-sm btn-success">WhatsApp üí¨</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <div id="notification"></div>

    <script type="module">
        // ===================================================================================
        // DADOS DO ESTABELECIMENTO - EDITE AQUI
        // ===================================================================================
        const ESTABELECIMENTO = {
            nome: "R.M. Est√©tica Automotiva",
            telefone: "(24) 99948-6232",
            endereco: "Rua 40, TV - Recanto dos P√°ssaros, Pq. Mambucaba, Angra dos Reis - RJ",
            agradecimento: "Obrigado pela prefer√™ncia e volte sempre! üëç"
        };

        // ===================================================================================
        // CONFIGURA√á√ÉO DO SUPABASE
        // ===================================================================================
        const SUPABASE_URL = 'https://uymunsavnpfcsuznrugi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5bXVuc2F2bnBmY3N1em5ydWdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3ODU3ODgsImV4cCI6MjA2NjM2MTc4OH0.Kz__-jB9SsD-w7SuwlYCWPuEOcOX9epRE9CB5jd4eFY';
        
        if (!SUPABASE_URL || !SUPABASE_KEY) {
            document.body.innerHTML = `<div style="padding: 40px; text-align: center; font-size: 1.2rem; color: #ffcc00; background-color: #333; height: 100vh;"><h1>Erro de Configura√ß√£o</h1><p>As credenciais do Supabase n√£o foram encontradas.</p></div>`;
            throw new Error("Credenciais do Supabase n√£o configuradas.");
        }

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ===================================================================================
        // IN√çCIO DA L√ìGICA DA APLICA√á√ÉO
        // ===================================================================================
        document.addEventListener('DOMContentLoaded', () => {

            let clientes = [], servicos = [], orcamentos = [];
            let editandoClienteId = null, editandoServicoId = null;
            let novoOrcamentoItens = [], orcamentoSelecionado = null;

            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            const navButtons = $$('.nav-btn'), tabContents = $$('.tab-content'), syncBtn = $('#sync-btn'), notification = $('#notification');
            const clienteForm = $('#cliente-form'), clienteFormTitle = $('#cliente-form-title'), clienteNomeInput = $('#cliente-nome'), clienteTelefoneInput = $('#cliente-telefone'), clienteCarroInput = $('#cliente-carro'), clientePlacaInput = $('#cliente-placa'), clientesLista = $('#clientes-lista'), cancelarEdicaoClienteBtn = $('#cancelar-edicao-cliente');
            const servicoForm = $('#servico-form'), servicoFormTitle = $('#servico-form-title'), servicoDescricaoInput = $('#servico-descricao'), servicoValorInput = $('#servico-valor'), servicosLista = $('#servicos-lista'), cancelarEdicaoServicoBtn = $('#cancelar-edicao-servico');
            const orcamentoForm = $('#orcamento-form'), orcamentoClienteSelect = $('#orcamento-cliente'), orcamentoServicoSelect = $('#orcamento-servico-select'), addServicoBtn = $('#add-servico-btn'), orcamentoServicosAdicionados = $('#orcamento-servicos-adicionados'), orcamentoDescontoInput = $('#orcamento-desconto'), orcamentoTotalDiv = $('#orcamento-total');
            const historicoLista = $('#historico-lista'), detalhesContainer = $('#detalhes-orcamento-container'), btnAprovar = $('#btn-aprovar'), btnFinalizar = $('#btn-finalizar'), btnExcluirOrcamento = $('#btn-excluir-orcamento');
            const orcamentoBloco = $('#detalhe-orcamento-bloco'), orcamentoTexto = $('#detalhes-orcamento-texto'), btnCopiarOrcamento = $('#btn-copiar-orcamento'), btnWhatsappOrcamento = $('#btn-whatsapp-orcamento');
            const reciboBloco = $('#detalhe-recibo-bloco'), reciboTexto = $('#detalhes-recibo-texto'), btnCopiarRecibo = $('#btn-copiar-recibo'), btnWhatsappRecibo = $('#btn-whatsapp-recibo');

            const showNotification = (message, type = 'success') => { notification.textContent = message; notification.className = `show ${type}`; setTimeout(() => { notification.className = notification.className.replace('show', ''); }, 3000); };
            const showTab = (tabId) => { tabContents.forEach(t => t.classList.remove('active')); navButtons.forEach(b => b.classList.remove('active')); $(`#${tabId}-tab`).classList.add('active'); $(`.nav-btn[data-tab="${tabId}"]`).classList.add('active'); };
            navButtons.forEach(b => b.addEventListener('click', () => showTab(b.dataset.tab)));
            const formatCurrency = (v) => parseFloat(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formatDateTime = (d) => d ? new Date(d).toLocaleString('pt-BR') : 'N/A';
            
            // --- Clientes ---
            const fetchClientes = async () => { const { data, error } = await db.from('clientes').select('*').order('nome', { ascending: true }); if (error) return showNotification('Erro ao buscar clientes.', 'error'); clientes = data; renderClientes(); renderOrcamentoClienteOptions(); };
            const renderClientes = () => { clientesLista.innerHTML = ''; if (!clientes.length) return clientesLista.innerHTML = '<li>Nenhum cliente cadastrado.</li>'; clientes.forEach(c => { clientesLista.innerHTML += `<li><div><strong>${c.nome}</strong><br><small>üöó ${c.carro || 'N/D'} | Áâå ${c.placa || 'N/D'}</small></div><div class="item-actions"><button class="btn btn-sm btn-secondary edit-cliente-btn" data-id="${c.id}">Editar</button><button class="btn btn-sm btn-danger delete-cliente-btn" data-id="${c.id}">üóëÔ∏è</button></div></li>`; }); };
            const handleClienteSubmit = async (e) => { e.preventDefault(); const data = { nome: clienteNomeInput.value, telefone: clienteTelefoneInput.value, carro: clienteCarroInput.value, placa: clientePlacaInput.value }; const { error } = editandoClienteId ? await db.from('clientes').update(data).eq('id', editandoClienteId) : await db.from('clientes').insert(data); if (error) return showNotification('Erro ao salvar cliente.', 'error'); showNotification(`Cliente ${editandoClienteId ? 'atualizado' : 'cadastrado'}!`); resetClienteForm(); fetchClientes(); };
            const handleEditCliente = (id) => { const c = clientes.find(cl => cl.id == id); if(!c) return; editandoClienteId = id; clienteFormTitle.textContent = 'Editar Cliente'; clienteNomeInput.value = c.nome; clienteTelefoneInput.value = c.telefone; clienteCarroInput.value = c.carro; clientePlacaInput.value = c.placa; cancelarEdicaoClienteBtn.style.display = 'block'; };
            const handleDeleteCliente = async (id) => { const { error } = await db.from('clientes').delete().eq('id', id); if (error) showNotification('Erro ao excluir cliente.', 'error'); else { showNotification('Cliente exclu√≠do.'); fetchClientes(); } };
            const resetClienteForm = () => { editandoClienteId = null; clienteForm.reset(); clienteFormTitle.textContent = 'Novo Cliente üßë‚Äçü§ù‚Äçüßë'; cancelarEdicaoClienteBtn.style.display = 'none'; };

            // --- Servi√ßos ---
            const fetchServicos = async () => { const { data, error } = await db.from('servicos').select('*').order('descricao', { ascending: true }); if (error) return showNotification('Erro ao buscar servi√ßos.', 'error'); servicos = data; renderServicos(); renderOrcamentoServicoOptions(); };
            const renderServicos = () => { servicosLista.innerHTML = ''; if (!servicos.length) return servicosLista.innerHTML = '<li>Nenhum servi√ßo cadastrado.</li>'; servicos.forEach(s => { servicosLista.innerHTML += `<li><div><strong>${s.descricao}</strong><br><small>${formatCurrency(s.valor)}</small></div><div class="item-actions"><button class="btn btn-sm btn-secondary edit-servico-btn" data-id="${s.id}">Editar</button><button class="btn btn-sm btn-danger delete-servico-btn" data-id="${s.id}">üóëÔ∏è</button></div></li>`; }); };
            const handleServicoSubmit = async (e) => { e.preventDefault(); const data = { descricao: servicoDescricaoInput.value, valor: servicoValorInput.value }; const { error } = editandoServicoId ? await db.from('servicos').update(data).eq('id', editandoServicoId) : await db.from('servicos').insert(data); if (error) return showNotification('Erro ao salvar servi√ßo.', 'error'); showNotification(`Servi√ßo ${editandoServicoId ? 'atualizado' : 'cadastrado'}!`); resetServicoForm(); fetchServicos(); };
            const handleEditServico = (id) => { const s = servicos.find(sv => sv.id == id); if (!s) return; editandoServicoId = id; servicoFormTitle.textContent = 'Editar Servi√ßo'; servicoDescricaoInput.value = s.descricao; servicoValorInput.value = s.valor; cancelarEdicaoServicoBtn.style.display = 'block'; };
            const handleDeleteServico = async (id) => { const { error } = await db.from('servicos').delete().eq('id', id); if (error) showNotification('Erro ao excluir servi√ßo.', 'error'); else { showNotification('Servi√ßo exclu√≠do.'); fetchServicos(); } };
            const resetServicoForm = () => { editandoServicoId = null; servicoForm.reset(); servicoFormTitle.textContent = 'Novo Servi√ßo üìã'; cancelarEdicaoServicoBtn.style.display = 'none'; };

            // --- Novo Or√ßamento ---
            const renderOrcamentoClienteOptions = () => { orcamentoClienteSelect.innerHTML = '<option value="">Selecione...</option>'; clientes.forEach(c => { orcamentoClienteSelect.innerHTML += `<option value="${c.id}">${c.nome}</option>`; }); };
            const renderOrcamentoServicoOptions = () => { orcamentoServicoSelect.innerHTML = '<option value="">Selecione...</option>'; servicos.forEach(s => { orcamentoServicoSelect.innerHTML += `<option value="${s.id}">${s.descricao} (${formatCurrency(s.valor)})</option>`; }); };
            const handleAddServicoToOrcamento = () => { const id = orcamentoServicoSelect.value; if (!id) return; const s = servicos.find(sv => sv.id == id); if(!s) return; if(novoOrcamentoItens.some(i => i.servico_id == s.id)) return showNotification('Servi√ßo j√° adicionado.', 'error'); novoOrcamentoItens.push({ servico_id: s.id, descricao_servico: s.descricao, valor_cobrado: s.valor }); renderNovoOrcamentoItens(); updateOrcamentoTotal(); orcamentoServicoSelect.value = ''; };
            const renderNovoOrcamentoItens = () => { orcamentoServicosAdicionados.innerHTML = ''; novoOrcamentoItens.forEach((item, index) => { orcamentoServicosAdicionados.innerHTML += `<li><span>${item.descricao_servico} - ${formatCurrency(item.valor_cobrado)}</span><button type="button" class="btn btn-sm btn-danger remove-servico-btn" data-index="${index}">x</button></li>`; }); };
            const handleRemoveServicoFromOrcamento = (index) => { novoOrcamentoItens.splice(index, 1); renderNovoOrcamentoItens(); updateOrcamentoTotal(); };
            const updateOrcamentoTotal = () => { const sub = novoOrcamentoItens.reduce((a, i) => a + parseFloat(i.valor_cobrado), 0); const desc = parseFloat(orcamentoDescontoInput.value) || 0; orcamentoTotalDiv.textContent = `TOTAL: ${formatCurrency(sub * (1 - desc / 100))}`; };
            const handleOrcamentoSubmit = async (e) => { e.preventDefault(); if (novoOrcamentoItens.length === 0 || !orcamentoClienteSelect.value) return showNotification('Cliente e ao menos um servi√ßo s√£o obrigat√≥rios.', 'error'); const sub = novoOrcamentoItens.reduce((a, i) => a + parseFloat(i.valor_cobrado), 0); const desc = parseFloat(orcamentoDescontoInput.value) || 0; const total = sub * (1 - desc / 100); const fpg = Array.from($$('input[name="pagamento"]:checked')).map(cb => cb.value).join(', '); const { data, error } = await db.from('orcamentos').insert({ cliente_id: orcamentoClienteSelect.value, desconto: desc, valor_total: total, status: 'Or√ßamento', formas_pagamento: fpg }).select().single(); if (error) return showNotification('Erro ao salvar or√ßamento.', 'error'); const itens = novoOrcamentoItens.map(i => ({ ...i, orcamento_id: data.id })); const { error: iError } = await db.from('orcamento_itens').insert(itens); if (iError) { showNotification('Erro ao salvar itens.', 'error'); await db.from('orcamentos').delete().eq('id', data.id); return; } showNotification('Or√ßamento salvo com sucesso!'); resetOrcamentoForm(); fetchAllData(); showTab('historico'); };
            const resetOrcamentoForm = () => { orcamentoForm.reset(); novoOrcamentoItens = []; renderNovoOrcamentoItens(); updateOrcamentoTotal(); };

            // --- Hist√≥rico ---
            const fetchOrcamentos = async () => { const { data, error } = await db.from('orcamentos').select(`id, created_at, valor_total, status, clientes ( nome )`).order('created_at', { ascending: false }); if (error) return showNotification('Erro ao buscar hist√≥rico.', 'error'); orcamentos = data; renderOrcamentos(); };
            const renderOrcamentos = () => { historicoLista.innerHTML = ''; if (!orcamentos.length) return historicoLista.innerHTML = '<li>Nenhum or√ßamento encontrado.</li>'; orcamentos.forEach(o => { historicoLista.innerHTML += `<li data-id="${o.id}"><div><strong>${o.clientes?.nome || 'Cliente Removido'}</strong><br><small>${formatDateTime(o.created_at)}</small></div><div><span class="status-indicator status-${o.status}">${o.status}</span><strong>${formatCurrency(o.valor_total)}</strong></div></li>`; }); };
            const handleHistoricoClick = async (id) => { $$('#historico-lista li').forEach(li => li.classList.remove('selected')); $(`#historico-lista li[data-id="${id}"]`).classList.add('selected'); const { data, error } = await db.from('orcamentos').select(`*, clientes (*), orcamento_itens (*)`).eq('id', id).single(); if (error) return showNotification('Erro ao buscar detalhes.', 'error'); orcamentoSelecionado = data; displayOrcamentoDetails(); };

            const displayOrcamentoDetails = () => {
                if (!orcamentoSelecionado) {
                    detalhesContainer.style.display = 'none';
                    return;
                }
                orcamentoTexto.textContent = generateOrcamentoText(orcamentoSelecionado);
                btnAprovar.style.display = orcamentoSelecionado.status === 'Or√ßamento' ? 'inline-block' : 'none';
                btnFinalizar.style.display = orcamentoSelecionado.status === 'Aprovado' ? 'inline-block' : 'none';
                if (orcamentoSelecionado.status === 'Finalizado') {
                    reciboTexto.textContent = generateReciboText(orcamentoSelecionado);
                    reciboBloco.style.display = 'block';
                } else {
                    reciboBloco.style.display = 'none';
                }
                detalhesContainer.style.display = 'block';
            };
            
            const updateStatusOrcamento = async (newStatus) => { if (!orcamentoSelecionado) return; const { error } = await db.from('orcamentos').update({ status: newStatus }).eq('id', orcamentoSelecionado.id); if (error) showNotification('Erro ao atualizar status.', 'error'); else { showNotification(`Or√ßamento ${newStatus.toLowerCase()}!`); orcamentoSelecionado.status = newStatus; displayOrcamentoDetails(); fetchOrcamentos(); } };
            const handleDeleteOrcamento = async () => { if (!orcamentoSelecionado || !confirm('Excluir este or√ßamento permanentemente?')) return; const { error } = await db.from('orcamentos').delete().eq('id', orcamentoSelecionado.id); if (error) showNotification('Erro ao excluir or√ßamento.', 'error'); else { showNotification('Or√ßamento exclu√≠do.'); orcamentoSelecionado = null; displayOrcamentoDetails(); fetchOrcamentos(); } };

            const copyToClipboard = (text, type) => { navigator.clipboard.writeText(text).then(() => showNotification(`${type} copiado com sucesso!`), () => showNotification(`Erro ao copiar ${type}.`, 'error')); };
            const sendWhatsAppMessage = (type) => { if (!orcamentoSelecionado) return; const text = type === 'orcamento' ? generateOrcamentoText(orcamentoSelecionado) : generateReciboText(orcamentoSelecionado); const phone = orcamentoSelecionado.clientes?.telefone; let url = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`; if (phone) { const cleanPhone = `55${phone.replace(/\D/g, '')}`; if (cleanPhone.length > 10) url = `https://api.whatsapp.com/send?phone=${cleanPhone}&text=${encodeURIComponent(text)}`; } window.open(url, '_blank'); };
            
            // --- FUN√á√ïES DE TEXTO ATUALIZADAS ---
            const generateFooter = () => `\n==================================\n*${ESTABELECIMENTO.nome}*\nüìç ${ESTABELECIMENTO.endereco}\n*üìû Contato:* ${ESTABELECIMENTO.telefone}\n\n_${ESTABELECIMENTO.agradecimento}_`;

            const generateOrcamentoText = (orc) => {
                const subtotal = orc.orcamento_itens.reduce((acc, item) => acc + parseFloat(item.valor_cobrado), 0);
                const servicosText = orc.orcamento_itens.map(item => `- ${item.descricao_servico} (${formatCurrency(item.valor_cobrado)})`).join('\n');
                return `*Or√ßamento - ${ESTABELECIMENTO.nome}*\n==================================\n*Data:* ${formatDateTime(orc.created_at)}\n*Cliente:* ${orc.clientes?.nome || 'N/A'}\n\n*SERVI√áOS:*\n${servicosText}\n\n*Subtotal:* ${formatCurrency(subtotal)}\n*Desconto:* ${orc.desconto}%\n*VALOR TOTAL:* ${formatCurrency(orc.valor_total)}\n\n*Formas de Pagamento:* ${orc.formas_pagamento || 'N√£o especificado'}` + generateFooter();
            };

            const generateReciboText = (orc) => {
                const servicosText = orc.orcamento_itens.map(item => `- ${item.descricao_servico}`).join('\n');
                return `*Recibo de Servi√ßo (N√£o Fiscal)*\n==================================\n*Data da Finaliza√ß√£o:* ${formatDateTime(new Date())}\n*Cliente:* ${orc.clientes?.nome || 'N/A'}\n\n*Servi√ßo(s) Realizado(s):*\n${servicosText}\n\n*Valor Pago:* ${formatCurrency(orc.valor_total)}` + generateFooter();
            };
            
            // --- INICIALIZA√á√ÉO E EVENT LISTENERS ---
            const fetchAllData = () => { showNotification('Sincronizando dados...'); fetchClientes(); fetchServicos(); fetchOrcamentos(); };
            syncBtn.addEventListener('click', fetchAllData);
            clienteForm.addEventListener('submit', handleClienteSubmit);
            cancelarEdicaoClienteBtn.addEventListener('click', resetClienteForm);
            clientesLista.addEventListener('click', (e) => { 
                const editBtn = e.target.closest('.edit-cliente-btn');
                const deleteBtn = e.target.closest('.delete-cliente-btn');
                if (editBtn) handleEditCliente(editBtn.dataset.id); 
                if (deleteBtn) handleDeleteCliente(deleteBtn.dataset.id);
            });
            servicoForm.addEventListener('submit', handleServicoSubmit);
            cancelarEdicaoServicoBtn.addEventListener('click', resetServicoForm);
            servicosLista.addEventListener('click', (e) => { 
                const editBtn = e.target.closest('.edit-servico-btn');
                const deleteBtn = e.target.closest('.delete-servico-btn');
                if (editBtn) handleEditServico(editBtn.dataset.id);
                if (deleteBtn) handleDeleteServico(deleteBtn.dataset.id);
            });
            addServicoBtn.addEventListener('click', handleAddServicoToOrcamento);
            orcamentoServicosAdicionados.addEventListener('click', (e) => { if (e.target.classList.contains('remove-servico-btn')) handleRemoveServicoFromOrcamento(e.target.dataset.index); });
            orcamentoDescontoInput.addEventListener('input', updateOrcamentoTotal);
            orcamentoForm.addEventListener('submit', handleOrcamentoSubmit);
            historicoLista.addEventListener('click', (e) => { const li = e.target.closest('li'); if (li?.dataset.id) handleHistoricoClick(li.dataset.id); });
            btnAprovar.addEventListener('click', () => updateStatusOrcamento('Aprovado'));
            btnFinalizar.addEventListener('click', () => updateStatusOrcamento('Finalizado'));
            
            // Lida com a exclus√£o de forma mais segura (long press)
            let pressTimer;
            const startPress = () => { pressTimer = setTimeout(() => { if (!orcamentoSelecionado) return; handleDeleteOrcamentoConfirmed(); }, 1500); };
            const cancelPress = () => clearTimeout(pressTimer);
            const handleDeleteOrcamentoConfirmed = async () => { if (!orcamentoSelecionado) return; const { error } = await db.from('orcamentos').delete().eq('id', orcamentoSelecionado.id); if (error) showNotification('Erro ao excluir or√ßamento.', 'error'); else { showNotification('Or√ßamento exclu√≠do com sucesso.'); orcamentoSelecionado = null; displayOrcamentoDetails(); fetchOrcamentos(); }};
            btnExcluirOrcamento.addEventListener('mousedown', startPress);
            btnExcluirOrcamento.addEventListener('touchstart', startPress);
            btnExcluirOrcamento.addEventListener('mouseup', cancelPress);
            btnExcluirOrcamento.addEventListener('mouseleave', cancelPress);
            btnExcluirOrcamento.addEventListener('touchend', cancelPress);
            btnExcluirOrcamento.addEventListener('click', (e) => { e.preventDefault(); showNotification("Mantenha o bot√£o pressionado para excluir.", "error");});

            btnCopiarOrcamento.addEventListener('click', () => { if(orcamentoSelecionado) copyToClipboard(generateOrcamentoText(orcamentoSelecionado), 'Or√ßamento'); });
            btnWhatsappOrcamento.addEventListener('click', () => sendWhatsAppMessage('orcamento'));
            btnCopiarRecibo.addEventListener('click', () => { if(orcamentoSelecionado) copyToClipboard(generateReciboText(orcamentoSelecionado), 'Recibo'); });
            btnWhatsappRecibo.addEventListener('click', () => sendWhatsAppMessage('recibo'));

            showTab('clientes');
            fetchAllData();
        });
    </script>
</body>
</html>
